# å‘½ä»¤ç¼–è¾‘å™¨å®ç°æ¨¡å¼æ–‡æ¡£

æœ¬æ–‡æ¡£æ€»ç»“äº† Editor2 é¡¹ç›®ä¸­ä¸åŒç±»å‹å‘½ä»¤çš„ç¼–è¾‘å™¨å®ç°æ¨¡å¼ï¼Œç”¨äºæŒ‡å¯¼æœªæ¥æ–°å‘½ä»¤ç¼–è¾‘å™¨çš„å¼€å‘ã€‚

---

## ç›®å½•
1. [ç¼–è¾‘å™¨åˆ†ç±»](#ç¼–è¾‘å™¨åˆ†ç±»)
2. [æ¨¡å¼ä¸€ï¼šç®€å•å‚æ•°ç¼–è¾‘å™¨](#æ¨¡å¼ä¸€ç®€å•å‚æ•°ç¼–è¾‘å™¨)
3. [æ¨¡å¼äºŒï¼šGroup é¡¹ç¼–è¾‘å™¨](#æ¨¡å¼äºŒgroup-é¡¹ç¼–è¾‘å™¨)
4. [æ¨¡å¼ä¸‰ï¼šå¤æ‚ JSON å‚æ•°ç¼–è¾‘å™¨](#æ¨¡å¼ä¸‰å¤æ‚-json-å‚æ•°ç¼–è¾‘å™¨)
5. [å¿«é€Ÿä¿®æ”¹æŒ‡å—](#å¿«é€Ÿä¿®æ”¹æŒ‡å—)
6. [å…³é”®å®ç°è¦ç‚¹](#å…³é”®å®ç°è¦ç‚¹)
7. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)

---

## ç¼–è¾‘å™¨åˆ†ç±»

æ ¹æ®å‘½ä»¤çš„å¤æ‚åº¦å’Œç¼–è¾‘æ–¹å¼ï¼Œç¼–è¾‘å™¨åˆ†ä¸ºä¸‰ç§æ¨¡å¼ï¼š

| æ¨¡å¼ | å‘½ä»¤ç±»å‹ | ç‰¹ç‚¹ | ä»£è¡¨å‘½ä»¤ |
|------|----------|------|----------|
| æ¨¡å¼ä¸€ | ç®€å•å‚æ•°å‘½ä»¤ | ç›´æ¥ç¼–è¾‘ params å­—æ®µï¼Œå®æ—¶åŒæ­¥ | `dialogue`, `message`, `narration`, `fade`, `actormotion`, `actorfacialmotion`, `backgroundsetting`, `transition` |
| æ¨¡å¼äºŒ | Group ç±»å‘½ä»¤ | ç¼–è¾‘ group å†…çš„å•ä¸ªé¡¹ï¼Œä¸“é—¨çš„ä¿å­˜é€»è¾‘ | `backgroundgroup`, `actorgroup`, `actorlayoutgroup`, `backgroundlayoutgroup`* |
| æ¨¡å¼ä¸‰ | å¤æ‚ JSON å‚æ•°å‘½ä»¤ | ç¼–è¾‘è½¬ä¹‰çš„ JSON å‚æ•°ï¼Œéœ€è¦åºåˆ—åŒ–/ååºåˆ—åŒ– | `camerasetting` |

\* `backgroundlayoutgroup` æ˜¯ç‰¹æ®Šçš„åªè¯»é€‰æ‹©å™¨ï¼Œä¸æ”¯æŒæ·»åŠ åŠŸèƒ½

---

## æ¨¡å¼ä¸€ï¼šç®€å•å‚æ•°ç¼–è¾‘å™¨

### é€‚ç”¨åœºæ™¯
- å‘½ä»¤åªæœ‰ç®€å•çš„æ–‡æœ¬ã€æ•°å­—ç­‰å‚æ•°
- å‚æ•°ç›´æ¥å­˜å‚¨åœ¨ `params` å¯¹è±¡ä¸­
- ä¸æ¶‰åŠåµŒå¥—ç»“æ„æˆ– JSON åºåˆ—åŒ–

### ä»£è¡¨å‘½ä»¤
- `dialogue` / `message` / `narration`
- `fade`
- `actormotion` / `actorfacialmotion`
- `backgroundsetting`
- `transition`

### å®ç°ç‰¹ç‚¹

#### 1. ç¼–è¾‘å™¨å®ç° (`DialogueEditor.tsx`)
```tsx
export const DialogueEditor: React.FC<DialogueEditorProps> = ({ card, onChange }) => {
  const [formData, setFormData] = useState(card);

  // å®æ—¶åŒæ­¥ï¼šformData å˜åŒ–æ—¶ç«‹å³é€šçŸ¥çˆ¶ç»„ä»¶
  useEffect(() => {
    onChange(formData);
  }, [formData]);

  const handleFieldChange = (key: string, value: any) => {
    setFormData(prev => ({
      ...prev,
      params: {
        ...prev.params,
        [key]: value,
      },
    }));
  };

  // ä½¿ç”¨ FormEditor æ¸²æŸ“è¡¨å•
  return <FormEditor sections={sections} onChange={handleFieldChange} />;
};
```

#### 2. ä¿å­˜é€»è¾‘ (`App.tsx`)
```tsx
const handleSaveEdit = () => {
  if (!editingCard || !editedCard) return;
  
  // ä½¿ç”¨ updateCommandText æ™ºèƒ½æ›´æ–°åŸå§‹å‘½ä»¤
  const newRawLine = updateCommandText(editingCard, editedCard);
  
  const updatedCard: CommandCard = {
    ...editedCard,
    isModified: true,
    raw_line: newRawLine,
  };
  
  // æ›´æ–°å¡ç‰‡åˆ—è¡¨
  setCards(prev => prev.map(c => c.id === updatedCard.id ? updatedCard : c));
  
  // æ›´æ–°é€‰ä¸­å¡ç‰‡
  if (selectedCard?.id === updatedCard.id) {
    setSelectedCard(updatedCard);
  }
};
```

#### 3. å‘½ä»¤æ–‡æœ¬æ›´æ–° (`updateCommandText`)
```tsx
// å¯¹äºç®€å•å‚æ•°ï¼Œä½¿ç”¨æ­£åˆ™æ›¿æ¢
for (const [key, value] of Object.entries(editedCard.params)) {
  if (value !== originalCard.params[key]) {
    const oldValue = originalCard.params[key];
    if (oldValue !== undefined && oldValue !== null) {
      const escapedOldValue = String(oldValue).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`${key}=${escapedOldValue}`, 'g');
      updatedText = updatedText.replace(regex, `${key}=${value}`);
    }
  }
}
```

### æ•°æ®æµ
```
ç”¨æˆ·è¾“å…¥ â†’ handleFieldChange â†’ setFormData â†’ useEffect â†’ onChange(formData)
       â†’ editedCard æ›´æ–° â†’ ç‚¹å‡»ä¿å­˜ â†’ updateCommandText â†’ raw_line æ›´æ–°
       â†’ å¡ç‰‡æ›´æ–° â†’ æ¸²æŸ“å™¨æ˜¾ç¤ºæ–°å€¼
```

### ç®€åŒ–ç¤ºä¾‹ï¼šFade ç¼–è¾‘å™¨

å¯¹äºåªæœ‰å°‘æ•°ç®€å•å‚æ•°çš„å‘½ä»¤ï¼Œå¯ä»¥ä¸ä½¿ç”¨ FormEditorï¼Œç›´æ¥åˆ›å»ºè¡¨å•å­—æ®µï¼š

#### ç¼–è¾‘å™¨å®ç° (`FadeEditor.tsx`)
```tsx
export const FadeEditor: React.FC<FadeEditorProps> = ({ card, onChange }) => {
  const [formData, setFormData] = useState({
    from: card.params.from ?? 1,
    to: card.params.to ?? 0,
  });

  // å®æ—¶åŒæ­¥
  useEffect(() => {
    onChange({
      ...card,
      params: {
        ...card.params,
        from: formData.from,
        to: formData.to,
      },
    });
  }, [formData]);

  return (
    <div className="form-container">
      <div className="form-field">
        <label className="form-label">from</label>
        <input
          type="number"
          className="form-input"
          value={formData.from}
          onChange={(e) => setFormData({ ...formData, from: parseFloat(e.target.value) || 0 })}
          step="0.1"
        />
        <div className="form-help-text">æ·¡å…¥æ·¡å‡ºèµ·å§‹å€¼ï¼ˆé€šå¸¸ä¸º 0 æˆ– 1ï¼‰</div>
      </div>

      <div className="form-field">
        <label className="form-label">to</label>
        <input
          type="number"
          className="form-input"
          value={formData.to}
          onChange={(e) => setFormData({ ...formData, to: parseFloat(e.target.value) || 0 })}
          step="0.1"
        />
        <div className="form-help-text">æ·¡å…¥æ·¡å‡ºç»“æŸå€¼ï¼ˆé€šå¸¸ä¸º 0 æˆ– 1ï¼‰</div>
      </div>
    </div>
  );
};
```

#### æ¸²æŸ“å™¨æ›´æ–° (`FadeRenderer.tsx`)
```tsx
const FadeRenderer: React.FC<Props> = ({ params, onEdit }) => (
  <ParamCard title="æ·¡å…¥æ·¡å‡ºè®¾ç½®" onEdit={onEdit}>
    <ParamRow label="ä»" value={params.from} />
    <ParamRow label="åˆ°" value={params.to} />
  </ParamCard>
);
```

#### å¡ç‰‡æ ‡é¢˜ç”Ÿæˆ (`command-card.ts`)
```tsx
case CommandType.Fade:
  const from = params.from !== undefined ? params.from : '?';
  const to = params.to !== undefined ? params.to : '?';
  return `æ·¡å…¥æ·¡å‡º: ${from} â†’ ${to}`;
```

**å…³é”®ç‚¹**ï¼š
- ä¸ä½¿ç”¨ `form-section` åŒ…è£¹ï¼Œä¸å…¶ä»–ç¼–è¾‘å™¨ä¿æŒä¸€è‡´
- ç›´æ¥åœ¨ `form-container` ä¸‹æ”¾ç½® `form-field`
- ä½¿ç”¨ `??` è¿ç®—ç¬¦æä¾›é»˜è®¤å€¼
- åœ¨å¡ç‰‡æ ‡é¢˜ä¸­æ˜¾ç¤ºå‚æ•°å€¼ï¼Œå¢å¼ºå¯è¯»æ€§

### é«˜çº§ç¤ºä¾‹ï¼šActorMotion ç¼–è¾‘å™¨ï¼ˆå¸¦ä¸‹æ‹‰é€‰æ‹©ï¼‰

å¯¹äºéœ€è¦ä»æ•°æ®åº“é€‰æ‹©èµ„æºæˆ–ä»å…¶ä»–å‘½ä»¤ä¸­æå–å¯é€‰é¡¹çš„æƒ…å†µï¼š

#### ç¼–è¾‘å™¨å®ç° (`ActorMotionEditor.tsx`)
```tsx
export const ActorMotionEditor: React.FC<ActorMotionEditorProps> = ({ card, onChange }) => {
  const [formData, setFormData] = useState({
    id: card.params.id || '',
    motion: card.params.motion || '',
  });
  
  const [availableActorIds, setAvailableActorIds] = useState<string[]>([]);
  const [motions, setMotions] = useState<Motion[]>([]);
  const [loadingMotions, setLoadingMotions] = useState(false);

  // ä»å…¨å±€cardsä¸­æå–actorgroupå®šä¹‰çš„è§’è‰²ID
  useEffect(() => {
    const getAllCards = (): CommandCard[] => {
      return (window as any).__editorCards || [];
    };
    
    const cards = getAllCards();
    const actorIds: string[] = [];
    
    for (const c of cards) {
      if (c.type === 'actorgroup') {
        const actors = parseActorGroup(c.params);
        actors.forEach((actor: any) => {
          if (actor.id && !actorIds.includes(actor.id)) {
            actorIds.push(actor.id);
          }
        });
      }
    }
    
    setAvailableActorIds(actorIds);
  }, []);

  // ä»Database APIåŠ è½½åŠ¨ä½œåˆ—è¡¨
  useEffect(() => {
    const loadMotions = async () => {
      setLoadingMotions(true);
      try {
        const response = await fetch(
          'http://localhost:5000/api/resources/motions?motion_type=character'
        );
        const data = await response.json();
        if (data.success) {
          setMotions(data.data);
        }
      } catch (err) {
        console.error('åŠ è½½åŠ¨ä½œåˆ—è¡¨å¤±è´¥:', err);
      } finally {
        setLoadingMotions(false);
      }
    };
    loadMotions();
  }, []);

  useEffect(() => {
    onChange({
      ...card,
      params: { ...card.params, id: formData.id, motion: formData.motion },
    });
  }, [formData]);

  return (
    <div className="form-container">
      {/* è§’è‰²ID - ä¸‹æ‹‰é€‰æ‹©æˆ–æ–‡æœ¬è¾“å…¥ */}
      <div className="form-field">
        <label className="form-label">è§’è‰²ID (id)</label>
        {availableActorIds.length > 0 ? (
          <select
            className="form-select"
            value={formData.id}
            onChange={(e) => setFormData({ ...formData, id: e.target.value })}
          >
            <option value="">è¯·é€‰æ‹©è§’è‰²...</option>
            {availableActorIds.map((actorId) => (
              <option key={actorId} value={actorId}>
                {actorId}
              </option>
            ))}
          </select>
        ) : (
          <input
            type="text"
            className="form-input"
            value={formData.id}
            onChange={(e) => setFormData({ ...formData, id: e.target.value })}
          />
        )}
        <div className="form-help-text">
          {availableActorIds.length > 0 
            ? 'åªèƒ½é€‰æ‹©åœ¨ actorgroup ä¸­å·²å®šä¹‰çš„è§’è‰²'
            : 'æœªæ‰¾åˆ°å·²å®šä¹‰çš„è§’è‰²ï¼Œè¯·å…ˆæ·»åŠ  actorgroup å‘½ä»¤'
          }
        </div>
      </div>

      {/* åŠ¨ä½œåç§° - ä»æ•°æ®åº“åŠ è½½ */}
      <div className="form-field">
        <label className="form-label">åŠ¨ä½œåç§° (motion)</label>
        {loadingMotions ? (
          <div className="form-loading">åŠ è½½åŠ¨ä½œåˆ—è¡¨ä¸­...</div>
        ) : motions.length > 0 ? (
          <select
            className="form-select"
            value={formData.motion}
            onChange={(e) => setFormData({ ...formData, motion: e.target.value })}
          >
            <option value="">è¯·é€‰æ‹©åŠ¨ä½œ...</option>
            {motions.map((motion) => (
              <option key={motion.id} value={motion.motion_name}>
                {motion.motion_name}
                {motion.character_id && ` (${motion.character_id})`}
              </option>
            ))}
          </select>
        ) : (
          <input
            type="text"
            className="form-input"
            value={formData.motion}
            onChange={(e) => setFormData({ ...formData, motion: e.target.value })}
          />
        )}
        <div className="form-help-text">
          {motions.length > 0 
            ? 'ä»æ•°æ®åº“ä¸­é€‰æ‹©åŠ¨ä½œèµ„æº'
            : 'æ‰‹åŠ¨è¾“å…¥åŠ¨ä½œåç§°ï¼Œæˆ–å¯åŠ¨ Database API æœåŠ¡å™¨'
          }
        </div>
      </div>
    </div>
  );
};
```

#### æš´éœ²cardsæ•°æ® (`App.tsx`)
```tsx
export const App: React.FC = () => {
  const [cards, setCards] = useState<CommandCard[]>([]);
  // ... å…¶ä»–çŠ¶æ€

  // å°†cardsæš´éœ²ç»™ç¼–è¾‘å™¨ä½¿ç”¨
  useEffect(() => {
    (window as any).__editorCards = cards;
    return () => {
      delete (window as any).__editorCards;
    };
  }, [cards]);
  
  // ...
};
```

#### æ¸²æŸ“å™¨å®ç° (`ActorMotionRenderer.tsx`)
```tsx
const ActorMotionRenderer: React.FC<Props> = ({ params, onEdit }) => (
  <ParamCard title="åŠ¨ä½œè®¾ç½®" onEdit={onEdit}>
    <ParamRow label="è§’è‰²ID" value={params.id} />
    <ParamRow label="åŠ¨ä½œåç§°" value={params.motion} />
  </ParamCard>
);
```

#### å¡ç‰‡æ ‡é¢˜ç”Ÿæˆ (`command-card.ts`)
```tsx
case CommandType.ActorMotion:
  return `åŠ¨ä½œ: ${params.id} - ${params.motion}`;
case CommandType.ActorFacialMotion:
  return `è¡¨æƒ…: ${params.id} - ${params.motion}`;
```

**å…³é”®ç‚¹**ï¼š
- å¹³æ»‘é™çº§ï¼šAPIä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æ–‡æœ¬è¾“å…¥
- ä»å…¶ä»–å‘½ä»¤æå–æ•°æ®ï¼šé€šè¿‡`window.__editorCards`è®¿é—®å…¨å±€cards
- åŠ è½½çŠ¶æ€ç®¡ç†ï¼šæ˜¾ç¤ºåŠ è½½ä¸­ã€é”™è¯¯é‡è¯•ç­‰çŠ¶æ€
- æ¸…æ™°çš„ç”¨æˆ·æç¤ºï¼šæ ¹æ®ä¸åŒæƒ…å†µæ˜¾ç¤ºä¸åŒçš„å¸®åŠ©æ–‡æœ¬
- å¤ç”¨ç¼–è¾‘å™¨ï¼šactorfacialmotionå¤ç”¨actormotionç¼–è¾‘å™¨
### BackgroundSetting ç¼–è¾‘å™¨ç¤ºä¾‹ï¼ˆå¸¦JSONå‚æ•°ï¼‰

å¯¹äºéœ€è¦ç¼–è¾‘2DèƒŒæ™¯ä½ç½®ã€ç¼©æ”¾ç­‰å‚æ•°çš„å‘½ä»¤ï¼š

#### ç¼–è¾‘å™¨å®ç° (`BackgroundSettingEditor.tsx`)
```tsx
export const BackgroundSettingEditor: React.FC<Props> = ({ card, onChange }) => {
  // è§£æç°æœ‰çš„setting JSON
  const parseSetting = (settingStr: string | undefined): BackgroundSetting => {
    if (!settingStr) return {};
    try {
      return JSON.parse(settingStr);
    } catch (e) {
      return {};
    }
  };

  const [formData, setFormData] = useState({
    id: card.params.id || '',
  });

  const [setting, setSetting] = useState<BackgroundSetting>(() => 
    parseSetting(card.params.setting)
  );

  const [availableBackgroundIds, setAvailableBackgroundIds] = useState<string[]>([]);

  // ä»backgroundgroupæå–å¯ç”¨èƒŒæ™¯ID
  useEffect(() => {
    const cards = (window as any).__editorCards || [];
    const bgIds: string[] = [];
    for (const c of cards) {
      if (c.type === 'backgroundgroup') {
        const backgrounds = parseBackgroundGroup(c.params);
        backgrounds.forEach((bg: any) => {
          if (bg.id && !bgIds.includes(bg.id)) {
            bgIds.push(bg.id);
          }
        });
      }
    }
    setAvailableBackgroundIds(bgIds);
  }, []);

  // åŒæ­¥JSONå‚æ•°
  useEffect(() => {
    const settingJson = JSON.stringify(setting);
    onChange({
      ...card,
      params: {
        ...card.params,
        id: formData.id,
        setting: settingJson,
      },
    });
  }, [formData, setting]);

  return (
    <div className="form-container">
      {/* èƒŒæ™¯ID - ç¦ç”¨è€Œéé™çº§ */}
      <div className="form-field">
        <label className="form-label">èƒŒæ™¯ID (id)</label>
        <select
          className="form-select"
          value={formData.id}
          onChange={(e) => setFormData({ ...formData, id: e.target.value })}
          disabled={availableBackgroundIds.length === 0}
        >
          <option value="">
            {availableBackgroundIds.length > 0 
              ? 'è¯·é€‰æ‹©èƒŒæ™¯...' 
              : 'æ— å¯ç”¨èƒŒæ™¯ï¼Œè¯·å…ˆæ·»åŠ  backgroundgroup'}
          </option>
          {availableBackgroundIds.map((bgId) => (
            <option key={bgId} value={bgId}>{bgId}</option>
          ))}
        </select>
        <div className="form-help-text">
          {availableBackgroundIds.length > 0 
            ? 'åªèƒ½é€‰æ‹©åœ¨ backgroundgroup ä¸­å·²å®šä¹‰çš„èƒŒæ™¯'
            : 'âš ï¸ æœªæ‰¾åˆ°å·²å®šä¹‰çš„èƒŒæ™¯ï¼Œè¯·å…ˆæ·»åŠ  backgroundgroup å‘½ä»¤'
          }
        </div>
      </div>

      {/* 2Då˜æ¢å‚æ•° */}
      <div className="form-section">
        <h4>ä½ç½® (Position)</h4>
        <div className="form-vector">
          <div className="form-vector-item">
            <label>X</label>
            <input
              type="number"
              value={setting.position?.x || 0}
              onChange={(e) => setSetting(prev => ({
                ...prev,
                position: { ...prev.position, x: parseFloat(e.target.value) || 0 }
              }))}
            />
          </div>
          <div className="form-vector-item">
            <label>Y</label>
            <input
              type="number"
              value={setting.position?.y || 0}
              onChange={(e) => setSetting(prev => ({
                ...prev,
                position: { ...prev.position, y: parseFloat(e.target.value) || 0 }
              }))}
            />
          </div>
        </div>
      </div>

      {/* ç¼©æ”¾å’Œè§’åº¦... */}
    </div>
  );
};
```

#### æ¸²æŸ“å™¨ (`BackgroundSettingRenderer.tsx`)
```tsx
const BackgroundSettingRenderer: React.FC<Props> = ({ params, onEdit }) => {
  const setting = parseBackgroundSetting(params);
  
  return (
    <ParamCard title="èƒŒæ™¯è®¾ç½®" onEdit={onEdit}>
      <ParamRow label="èƒŒæ™¯ID" value={params.id} />
      {setting?.position && (
        <ParamRow 
          label="ä½ç½®" 
          value={setting.position}
          formatter={(v) => `x: ${v.x?.toFixed(1)}, y: ${v.y?.toFixed(1)}`}
        />
      )}
      {setting?.scale && (
        <ParamRow 
          label="ç¼©æ”¾" 
          value={setting.scale}
          formatter={(v) => `x: ${v.x?.toFixed(2)}, y: ${v.y?.toFixed(2)}`}
        />
      )}
    </ParamCard>
  );
};
```

#### å¡ç‰‡æ ‡é¢˜ (`command-card.ts`)
```tsx
case CommandType.BackgroundSetting:
  try {
    const setting = params.setting ? JSON.parse(params.setting) : null;
    if (setting?.position) {
      const pos = setting.position;
      return `2DèƒŒæ™¯: ${params.id || 'æœªçŸ¥'} (${pos.x?.toFixed(1)}, ${pos.y?.toFixed(1)})`;
    }
  } catch (e) {
    // è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ˜¾ç¤º
  }
  return `2DèƒŒæ™¯è®¾ç½®: ${params.id || "æœªçŸ¥"}`;
```

**å…³é”®ç‚¹**ï¼š
- **å¼ºåˆ¶ä¾èµ–éªŒè¯**ï¼šä½¿ç”¨ `disabled` å±æ€§è€Œéé™çº§åˆ°æ–‡æœ¬è¾“å…¥
- **JSONåºåˆ—åŒ–**ï¼šsettingå‚æ•°éœ€è¦JSON.stringify/parseå¤„ç†
- **å‘é‡è¾“å…¥**ï¼šä½¿ç”¨form-sectionç»„ç»‡å¤šä¸ªç›¸å…³è¾“å…¥
- **æ¡ä»¶æ¸²æŸ“**ï¼šåªåœ¨æœ‰å€¼æ—¶æ˜¾ç¤ºå‚æ•°
- **è­¦å‘Šæç¤º**ï¼šä½¿ç”¨ âš ï¸ å›¾æ ‡æé†’ç”¨æˆ·ç¼ºå°‘å‰ç½®æ¡ä»¶

### Transition ç¼–è¾‘å™¨ç¤ºä¾‹ï¼ˆæ¡ä»¶å‚æ•°ä¸éªŒè¯ï¼‰

å¯¹äºéœ€è¦æ ¹æ®æŸä¸ªå‚æ•°çš„å€¼åŠ¨æ€æ§åˆ¶å…¶ä»–å‚æ•°æ˜¯å¦æ˜¾ç¤ºå’Œå¿…å¡«çš„å‘½ä»¤ï¼š

#### ç¼–è¾‘å™¨å®ç° (`TransitionEditor.tsx`)
```tsx
export const TransitionEditor: React.FC<TransitionEditorProps> = ({ card, onChange }) => {
  const [formData, setFormData] = useState(card);

  // åˆå§‹åŒ–æ—¶æ¸…ç†ä¸åº”è¯¥å­˜åœ¨çš„characterå‚æ•°
  useEffect(() => {
    const isEventType = 
      formData.params.transition === 'ttn_adv_transition_event_change' || 
      formData.params.transition === 'ttn_adv_transition_event_time';
    
    if (isEventType && formData.params.character !== undefined) {
      const cleanedParams = { ...formData.params };
      delete cleanedParams.character;
      setFormData({ ...formData, params: cleanedParams });
    }
  }, []);

  useEffect(() => {
    // éªŒè¯é€»è¾‘ï¼šéeventç±»å‹æ—¶ï¼Œcharacterå¿…é¡»æœ‰å€¼ä¸”ä¸ä¸ºç©º
    const isEventType = 
      formData.params.transition === 'ttn_adv_transition_event_change' || 
      formData.params.transition === 'ttn_adv_transition_event_time';
    
    const isValid = isEventType 
      ? true  // eventç±»å‹ä¸éœ€è¦characterï¼Œæ€»æ˜¯æœ‰æ•ˆ
      : !!(formData.params.character && formData.params.character.trim() !== '');
    
    onChange(formData, isValid);  // ä¼ é€’éªŒè¯çŠ¶æ€
  }, [formData]);

  const handleFieldChange = (key: string, value: any) => {
    setFormData(prev => {
      const currentTransition = key === 'transition' ? value : prev.params.transition;
      const isEventType = 
        currentTransition === 'ttn_adv_transition_event_change' || 
        currentTransition === 'ttn_adv_transition_event_time';
      
      const newParams: any = {};
      newParams.transition = key === 'transition' ? value : prev.params.transition;
      
      if (prev.params.type !== undefined || key === 'type') {
        newParams.type = key === 'type' ? value : prev.params.type;
      }
      
      // characterå‚æ•°ï¼ˆä»…åœ¨éeventç±»å‹æ—¶ï¼‰
      if (!isEventType) {
        newParams.character = key === 'character' ? value : (prev.params.character || '');
      }
      
      if (prev.params.clip !== undefined) {
        newParams.clip = prev.params.clip;
      }

      return { ...prev, params: newParams };
    });
  };

  const isCharacterDisabled = 
    formData.params.transition === 'ttn_adv_transition_event_change' || 
    formData.params.transition === 'ttn_adv_transition_event_time';

  const sections: FormSection[] = [
    {
      title: 'åœºæ™¯è¿‡æ¸¡è®¾ç½®',
      fields: [
        {
          key: 'transition',
          label: 'è¿‡æ¸¡æ•ˆæœ',
          type: 'select',
          value: formData.params.transition || '',
          options: TRANSITION_EFFECTS,
          hint: 'é€‰æ‹©è¿‡æ¸¡åŠ¨ç”»æ•ˆæœç±»å‹'
        },
        {
          key: 'type',
          label: 'ç±»å‹',
          type: 'select',
          value: formData.params.type || 'In',
          options: TYPE_OPTIONS,
          hint: 'In: æ·¡å…¥æ•ˆæœ | Out: æ·¡å‡ºæ•ˆæœ'
        },
        {
          key: 'character',
          label: isCharacterDisabled ? 'è§’è‰² (æ­¤ç±»å‹ä¸éœ€è¦)' : 'è§’è‰² *',
          type: 'select',
          value: isCharacterDisabled ? '' : (formData.params.character || ''),
          options: CHARACTER_LIST,
          hint: isCharacterDisabled 
            ? 'event_changeå’Œevent_timeç±»å‹ä¸ä½¿ç”¨è§’è‰²å‚æ•°' 
            : 'é€‰æ‹©åº”ç”¨è¿‡æ¸¡æ•ˆæœçš„è§’è‰²ï¼ˆå¿…å¡«ï¼Œæœªé€‰æ‹©æ—¶æ— æ³•ä¿å­˜ï¼‰',
          disabled: isCharacterDisabled
        }
      ]
    }
  ];

  return <FormEditor sections={sections} onChange={handleFieldChange} />;
};
```

#### æ¸²æŸ“å™¨ (`TransitionRenderer.tsx`)
```tsx
const TransitionRenderer: React.FC<Props> = ({ params, onEdit }) => {
  const isEventType = 
    params.transition === 'ttn_adv_transition_event_change' || 
    params.transition === 'ttn_adv_transition_event_time';
  
  return (
    <ParamCard title="è½¬åœºè®¾ç½®" onEdit={onEdit}>
      <ParamRow label="è¿‡æ¸¡æ•ˆæœ" value={params.transition || '(æœªè®¾ç½®)'} />
      <ParamRow label="ç±»å‹" value={params.type || '(æœªè®¾ç½®)'} />
      {!isEventType && (
        <ParamRow label="è§’è‰²" value={params.character || '(æœªè®¾ç½®)'} />
      )}
    </ParamCard>
  );
};
```

#### å¡ç‰‡æ ‡é¢˜ (`command-card.ts`)
```tsx
case CommandType.Transition:
  const transitionName = params.transition ? params.transition.replace('ttn_adv_transition_', '') : '?';
  const transitionType = params.type || '?';
  const isEventType = params.transition === 'ttn_adv_transition_event_change' || 
                      params.transition === 'ttn_adv_transition_event_time';
  if (isEventType) {
    return `åœºæ™¯è¿‡æ¸¡: ${transitionName} (${transitionType})`;
  } else {
    const transitionChar = params.character || '(æœªé€‰æ‹©)';
    return `åœºæ™¯è¿‡æ¸¡: ${transitionName} (${transitionType}) - ${transitionChar}`;
  }
```

#### App.tsx ä¸­çš„å®æ—¶æ ‡é¢˜æ›´æ–°
```tsx
const handleEditorChange = (updatedCard: CommandCard, isValid?: boolean) => {
  // é‡æ–°ç”Ÿæˆå¡ç‰‡æ ‡é¢˜
  const updatedCardWithTitle = {
    ...updatedCard,
    title: generateCardTitle(updatedCard)  // ä¼ é€’å®Œæ•´çš„cardå¯¹è±¡
  };
  setEditedCard(updatedCardWithTitle);
  if (isValid !== undefined) {
    setCanSaveEdit(isValid);
  }
};
```

#### ä¿å­˜æ—¶å¤„ç†å‚æ•°åˆ é™¤ (`App.tsx`)
```tsx
const updateCommandText = (originalCard: CommandCard, editedCard: CommandCard): string => {
  // ...
  // æ£€æŸ¥å‚æ•°æ•°é‡æ˜¯å¦å˜åŒ–ï¼ˆæœ‰å‚æ•°è¢«åˆ é™¤æˆ–æ·»åŠ ï¼‰
  const originalParamKeys = Object.keys(originalCard.params);
  const editedParamKeys = Object.keys(editedCard.params);
  if (originalParamKeys.length !== editedParamKeys.length) {
    console.log('ğŸ“ å‚æ•°æ•°é‡å˜åŒ–ï¼Œé‡å»ºå‘½ä»¤');
    return generateFullCommandText(editedCard);
  }
  // ...
};
```

**å…³é”®ç‚¹**ï¼š
- **æ¡ä»¶å‚æ•°**ï¼šæ ¹æ®transitionç±»å‹åŠ¨æ€æ·»åŠ /åˆ é™¤characterå‚æ•°
- **æ¡ä»¶éªŒè¯**ï¼ševentç±»å‹ä¸éªŒè¯characterï¼Œéeventç±»å‹å¿…é¡»éªŒè¯
- **æ¡ä»¶æ¸²æŸ“**ï¼ševentç±»å‹åœ¨æ¸²æŸ“å™¨å’Œæ ‡é¢˜ä¸­éšè—character
- **å‚æ•°åˆ é™¤æ£€æµ‹**ï¼šä¿å­˜æ—¶æ£€æŸ¥å‚æ•°æ•°é‡å˜åŒ–ï¼Œè§¦å‘å®Œæ•´é‡å»º
- **å®æ—¶æ ‡é¢˜æ›´æ–°**ï¼šç¼–è¾‘æ—¶é€šè¿‡`generateCardTitle`å®æ—¶æ›´æ–°å¡ç‰‡æ ‡é¢˜
- **ç¦ç”¨vséšè—**ï¼šç¼–è¾‘å™¨ä¸­ç¦ç”¨å­—æ®µï¼ˆç°æ˜¾ï¼‰ï¼Œæ¸²æŸ“å™¨ä¸­å®Œå…¨éšè—

**æ•°æ®æµ**ï¼š
```
é€‰æ‹©eventç±»å‹ â†’ handleFieldChange â†’ åˆ é™¤characterå‚æ•° â†’ onChange(card, true)
             â†’ Appæ›´æ–°æ ‡é¢˜ â†’ å¡ç‰‡æ˜¾ç¤º"event_change (In)"
             â†’ ç‚¹å‡»ä¿å­˜ â†’ æ£€æµ‹å‚æ•°æ•°é‡å˜åŒ– â†’ é‡å»ºå‘½ä»¤
             â†’ åŸå§‹å‘½ä»¤æ— characterå‚æ•°

é€‰æ‹©éeventç±»å‹ â†’ handleFieldChange â†’ æ·»åŠ characterå‚æ•°(ç©º) â†’ onChange(card, false)
               â†’ ä¿å­˜æŒ‰é’®ç¦ç”¨ â†’ ç”¨æˆ·å¿…é¡»é€‰æ‹©è§’è‰²
               â†’ é€‰æ‹©è§’è‰² â†’ onChange(card, true) â†’ ä¿å­˜æŒ‰é’®å¯ç”¨
```


---

## æ¨¡å¼äºŒï¼šGroup é¡¹ç¼–è¾‘å™¨

### é€‚ç”¨åœºæ™¯
- å‘½ä»¤åŒ…å«å¤šä¸ªå­é¡¹ï¼ˆå¦‚å¤šä¸ªèƒŒæ™¯ã€å¤šä¸ªè§’è‰²ï¼‰
- éœ€è¦å•ç‹¬ç¼–è¾‘ã€æ·»åŠ ã€åˆ é™¤å­é¡¹
- å­é¡¹æ ¼å¼ä¸º `[itemtype ...]` çš„åµŒå¥—ç»“æ„

### ä»£è¡¨å‘½ä»¤
- `backgroundgroup`: `[backgroundgroup backgrounds=[background id=... src=...] ...]`
- `actorgroup`: `[actorgroup actors=[actor id=... body=...] ...]`
- `actorlayoutgroup`: `[actorlayoutgroup layouts=[actorlayout id=... transform=\{...\}] ...]`

### å®ç°ç‰¹ç‚¹

#### 1. å­é¡¹ç¼–è¾‘å™¨ (`BackgroundItemEditor.tsx`)
```tsx
const BackgroundItemEditor: React.FC<Props> = ({ id, src, onChange }) => {
  const [localData, setLocalData] = useState({ id, src });

  // å®æ—¶é€šçŸ¥çˆ¶ç»„ä»¶
  useEffect(() => {
    onChange(localData.id, localData.src);
  }, [localData]);

  return (
    <div>
      <input value={localData.id} onChange={(e) => setLocalData({...localData, id: e.target.value})} />
      <input value={localData.src} onChange={(e) => setLocalData({...localData, src: e.target.value})} />
    </div>
  );
};
```

#### 2. ç¼–è¾‘æµç¨‹ (`App.tsx`)
```tsx
// æ­¥éª¤1: ç‚¹å‡»ç¼–è¾‘æŒ‰é’®ï¼Œæ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
const handleEditGroupItem = (card: CommandCard, itemIndex: number, itemType: string) => {
  if (itemType === 'background') {
    const backgrounds = parseBackgroundGroup(card.params);
    const bg = backgrounds[itemIndex];
    setEditingCard(card);
    setEditingItemIndex(itemIndex);
    setEditingItemData({ id: bg.id, src: bg.src });
  }
};

// æ­¥éª¤2: ä¿å­˜ç¼–è¾‘
const saveBackgroundGroupItem = () => {
  const backgrounds = parseBackgroundGroup(editingCard.params);
  
  // æ›´æ–°æˆ–æ·»åŠ é¡¹
  if (editingItemIndex === -2) {
    backgrounds.push(editingItemData); // æ·»åŠ æ¨¡å¼
  } else {
    backgrounds[editingItemIndex] = editingItemData; // ç¼–è¾‘æ¨¡å¼
  }
  
  // é‡æ–°ç”Ÿæˆå‘½ä»¤å­—ç¬¦ä¸²
  const backgroundStrs = backgrounds.map(bg => 
    `[background id=${bg.id} src=${bg.src}]`
  );
  
  // æ›´æ–° params.backgroundsï¼ˆå†…éƒ¨æ ¼å¼ï¼‰
  const newBackgroundsParam = backgrounds
    .map(bg => `id=${bg.id} src=${bg.src}`)
    .join(' ||| ');
  
  // æ›´æ–°å¡ç‰‡
  const updatedCard: CommandCard = {
    ...editingCard,
    params: { ...editingCard.params, backgrounds: newBackgroundsParam },
    isModified: true,
    raw_line: updateBackgroundGroupText(editingCard, backgroundStrs),
  };
  
  // æ›´æ–°åˆ—è¡¨å’Œé€‰ä¸­çŠ¶æ€
  setCards(prev => prev.map(c => c.id === updatedCard.id ? updatedCard : c));
  if (selectedCard?.id === updatedCard.id) {
    setSelectedCard(updatedCard);
  }
};
```

#### 3. å‘½ä»¤æ–‡æœ¬é‡å»º (`updateBackgroundGroupText`)
```tsx
const updateBackgroundGroupText = (card: CommandCard, backgroundStrs: string[]): string => {
  // å®Œå…¨é‡å»ºå‘½ä»¤ï¼Œä¿ç•™ clip ç­‰å…¶ä»–å‚æ•°
  const newBackgroundParams = backgroundStrs.map(bg => `backgrounds=${bg}`).join(' ');
  
  // æå– clip å‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰
  const clipMatch = card.raw_line.match(/clip=\\?\{[^}]+\\?\}/);
  const clipParam = clipMatch ? ` ${clipMatch[0]}` : '';
  
  return `[backgroundgroup ${newBackgroundParams}${clipParam}]`;
};
```

### æ•°æ®æµ

#### ç¼–è¾‘æµç¨‹
```
ç‚¹å‡»ç¼–è¾‘ â†’ handleEditGroupItem â†’ æ‰“å¼€å¯¹è¯æ¡† â†’ ç¼–è¾‘æ•°æ®
       â†’ setEditingItemData â†’ ç‚¹å‡»ä¿å­˜ â†’ saveBackgroundGroupItem
       â†’ é‡å»ºæ•´ä¸ªå‘½ä»¤ â†’ raw_line æ›´æ–° â†’ å¡ç‰‡æ›´æ–° â†’ æ¸²æŸ“å™¨æ˜¾ç¤º
```

#### æ·»åŠ æµç¨‹
```
ç‚¹å‡»æ·»åŠ æŒ‰é’® â†’ handleAddGroupItem â†’ è®¾ç½®é»˜è®¤æ•°æ® â†’ æ‰“å¼€å¯¹è¯æ¡†
            â†’ ç¼–è¾‘æ•°æ® â†’ ç‚¹å‡»ä¿å­˜ â†’ saveBackgroundGroupItem (index=-2)
            â†’ æ·»åŠ åˆ°æ•°ç»„ â†’ é‡å»ºå‘½ä»¤ â†’ æ›´æ–°å¡ç‰‡
```

### 4. æ·»åŠ æŒ‰é’®å®ç°

#### æ¸²æŸ“å™¨ä¸­æ·»åŠ æŒ‰é’® (`BackgroundGroupRenderer.tsx`)
```tsx
import { ParamRow, ParamCard, AddItemButton } from './ParamRow';

const BackgroundGroupRenderer: React.FC<RendererProps> = ({ 
  params, 
  onEditItem, 
  onAddItem  // æ¥æ”¶æ·»åŠ å›è°ƒ
}) => {
  const backgrounds = parseBackgroundGroup(params);
  
  return (
    <>
      {backgrounds.map((bg, index) => (
        <ParamCard key={index} title="èƒŒæ™¯è®¾ç½®" onEdit={() => onEditItem(index)}>
          <ParamRow label="èƒŒæ™¯ID" value={bg.id} />
          <ParamRow label="èµ„æºè·¯å¾„" value={bg.src} />
        </ParamCard>
      ))}
      
      {/* æ·»åŠ æŒ‰é’® - åªæœ‰æä¾›äº†å›è°ƒæ‰æ˜¾ç¤º */}
      {onAddItem && <AddItemButton label="æ·»åŠ èƒŒæ™¯è®¾ç½®" onClick={onAddItem} />}
    </>
  );
};
```

#### æ·»åŠ æŒ‰é’®ç»„ä»¶ (`ParamRow.tsx`)
```tsx
/**
 * æ·»åŠ é¡¹æŒ‰é’®ç»„ä»¶ - é€šç”¨äºæ‰€æœ‰ Group ç±»å‹å‘½ä»¤
 */
export const AddItemButton: React.FC<{ 
  label: string; 
  onClick: () => void 
}> = ({ label, onClick }) => {
  return (
    <div className="detail-section">
      <button 
        className="detail-add-btn" 
        onClick={onClick}
        title={label}
      >
        + {label}
      </button>
    </div>
  );
};
```

#### App.tsx ä¸­è¿æ¥æ·»åŠ é€»è¾‘
```tsx
// æ·»åŠ æ–°é¡¹
const handleAddGroupItem = (card: CommandCard, itemType: string) => {
  setEditingCard(card);
  setEditingItemIndex(-2); // ä½¿ç”¨ -2 è¡¨ç¤ºæ·»åŠ æ¨¡å¼ï¼ˆåŒºåˆ†ç¼–è¾‘æ¨¡å¼ï¼‰
  
  // æ ¹æ®ç±»å‹è®¾ç½®é»˜è®¤å€¼
  if (itemType === 'background') {
    setEditingItemData({ id: '', src: '' });
  } else if (itemType === 'actor') {
    setEditingItemData({ id: '', body: '', face: '', hair: '' });
  } else if (itemType === 'actorlayout') {
    setEditingItemData({ 
      id: '', 
      transform: {
        position: { x: 0, y: 0, z: 0 },
        rotation: { x: 0, y: 0, z: 0 },
        scale: { x: 1, y: 1, z: 1 },
      }
    });
  }
  // æœªæ¥å¯ä»¥æ‰©å±•å…¶ä»–ç±»å‹
};

// æ¸²æŸ“å‘½ä»¤è¯¦æƒ…æ—¶ä¼ é€’æ·»åŠ å›è°ƒ
const renderCommandDetails = (card: CommandCard) => {
  const Renderer = getRenderer(card.type);
  const props: any = {
    params: card.params,
    onEdit: () => handleCardEdit(card),
  };
  
  // ä¸º group ç±»å‹å‘½ä»¤æ·»åŠ é€šç”¨çš„é¡¹ç¼–è¾‘å’Œæ·»åŠ å›è°ƒ
  if (card.type === 'backgroundgroup') {
    props.onEditItem = (index: number) => handleEditGroupItem(card, index, 'background');
    props.onAddItem = () => handleAddGroupItem(card, 'background');  // æ·»åŠ å›è°ƒ
  } else if (card.type === 'actorgroup') {
    props.onEditItem = (index: number) => handleEditGroupItem(card, index, 'actor');
    props.onAddItem = () => handleAddGroupItem(card, 'actor');
  } else if (card.type === 'actorlayoutgroup') {
    props.onEditItem = (index: number) => handleEditGroupItem(card, index, 'actorlayout');
    props.onAddItem = () => handleAddGroupItem(card, 'actorlayout');
  }
  
  return <Renderer {...props} />;
};
```

#### ä¿å­˜é€»è¾‘ä¸­å¤„ç†æ·»åŠ æ¨¡å¼
```tsx
const saveBackgroundGroupItem = () => {
  if (!editingCard) return;
  
  const backgrounds = parseBackgroundGroup(editingCard.params);
  
  // æ·»åŠ æ¨¡å¼ï¼ˆindex = -2ï¼‰
  if (editingItemIndex === -2) {
    backgrounds.push({
      id: editingItemData.id || '',
      src: editingItemData.src || '',
    });
  }
  // ç¼–è¾‘æ¨¡å¼ï¼ˆindex >= 0ï¼‰
  else if (editingItemIndex >= 0 && editingItemIndex < backgrounds.length) {
    backgrounds[editingItemIndex] = {
      id: editingItemData.id || '',
      src: editingItemData.src || '',
    };
  } else {
    return;
  }
  
  // ... é‡å»ºå‘½ä»¤çš„é€»è¾‘ç›¸åŒ
};
```

#### å¯¹è¯æ¡†æ ‡é¢˜åŠ¨æ€æ˜¾ç¤º
```tsx
<EditDialog
  title={
    editingItemIndex === -2 
      ? `æ·»åŠ ${getItemTypeName(editingCard.type)}`  // æ·»åŠ æ¨¡å¼
      : `ç¼–è¾‘${getItemTypeName(editingCard.type)} #${editingItemIndex + 1}`  // ç¼–è¾‘æ¨¡å¼
  }
  isOpen={true}
  onClose={handleCancelGroupItem}
  onSave={handleSaveGroupItem}
>
  {renderGroupItemEditor(editingCard.type)}
</EditDialog>
```

### å…³é”®ç‚¹
1. **ä¸ç›´æ¥ä¿®æ”¹ card**ï¼šç¼–è¾‘æ—¶ä½¿ç”¨ç‹¬ç«‹çš„ `editingItemData` çŠ¶æ€
2. **å®Œæ•´é‡å»ºå‘½ä»¤**ï¼šä¸ä½¿ç”¨æ­£åˆ™æ›¿æ¢ï¼Œè€Œæ˜¯é‡æ–°ç”Ÿæˆæ•´ä¸ªå‘½ä»¤å­—ç¬¦ä¸²
3. **ä¿ç•™å…¶ä»–å‚æ•°**ï¼šé‡å»ºæ—¶è¦ä¿ç•™ `clip` ç­‰å…¶ä»–å‚æ•°
4. **å†…éƒ¨æ ¼å¼**ï¼š`params.backgrounds` ä½¿ç”¨ `|||` åˆ†éš”ï¼Œæ–¹ä¾¿è§£æ

### 5. ç‰¹æ®Šæ¡ˆä¾‹ï¼šBackgroundLayoutGroupï¼ˆåªè¯»é€‰æ‹©å™¨ï¼‰

`backgroundlayoutgroup` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Group ç±»å‘½ä»¤ï¼Œå®ƒ**åªå…è®¸ç¼–è¾‘ç°æœ‰é¡¹ï¼Œä¸æ”¯æŒæ·»åŠ æ–°é¡¹**ã€‚

#### è®¾è®¡åŸå› 
- `backgroundgroup` è´Ÿè´£å®šä¹‰ 3D èƒŒæ™¯ï¼ˆæ·»åŠ å’Œç¼–è¾‘ï¼‰
- `backgroundlayoutgroup` è´Ÿè´£å¸ƒå±€ç°æœ‰çš„ 3D èƒŒæ™¯ï¼ˆåªèƒ½ä» backgroundgroup ä¸­é€‰æ‹©ï¼‰
- æ·»åŠ æ–°çš„ 3D èƒŒæ™¯åº”è¯¥åœ¨ `backgroundgroup` ä¸­å®Œæˆ

#### å®ç°ç‰¹ç‚¹

**å­é¡¹ç¼–è¾‘å™¨** (`BackgroundLayoutGroupItemEditor.tsx`):
```tsx
const BackgroundLayoutGroupItemEditor: React.FC<Props> = ({ 
  id, 
  onChange,
  onValidate  // éªŒè¯å›è°ƒ
}) => {
  const [formData, setFormData] = useState({ id });
  const [availableBackgrounds, setAvailableBackgrounds] = useState<string[]>([]);

  // ä» backgroundgroup æå–å¯ç”¨çš„ 3D èƒŒæ™¯
  useEffect(() => {
    const cards = (window as any).__editorCards || [];
    const bgGroups = cards.filter((c: any) => c.type === 'backgroundgroup');
    
    const bgIds: string[] = [];
    bgGroups.forEach((card: any) => {
      const backgrounds = parseBackgroundGroup(card.params);
      backgrounds.forEach(bg => {
        // åªåŒ…å« 3D èƒŒæ™¯ï¼ˆä¸åŒ…å« .png/.jpgï¼‰
        if (bg.id && !bg.src?.match(/\.(png|jpg|jpeg)$/i)) {
          bgIds.push(bg.id);
        }
      });
    });
    
    setAvailableBackgrounds([...new Set(bgIds)]);
  }, []);

  // å®æ—¶éªŒè¯å’ŒåŒæ­¥
  useEffect(() => {
    onChange(formData.id);
    if (onValidate) {
      onValidate(formData.id.trim() !== '');  // å¿…é¡»é€‰æ‹©æœ‰æ•ˆçš„ ID
    }
  }, [formData, onValidate]);

  return (
    <div className="form-container">
      <div className="form-field">
        <label>3DèƒŒæ™¯ID</label>
        {availableBackgrounds.length > 0 ? (
          <select
            value={formData.id}
            onChange={(e) => setFormData({ id: e.target.value })}
          >
            <option value="">(æœªè®¾ç½®)</option>
            {availableBackgrounds.map(id => (
              <option key={id} value={id}>{id}</option>
            ))}
          </select>
        ) : (
          <div>
            <input type="text" value={formData.id} disabled />
            <div className="warning">âš ï¸ è¯·å…ˆåœ¨ backgroundgroup ä¸­æ·»åŠ  3D èƒŒæ™¯</div>
          </div>
        )}
      </div>
    </div>
  );
};
```

**æ¸²æŸ“å™¨**ä¸åŒ…å« AddItemButton (`BackgroundLayoutGroupRenderer.tsx`):
```tsx
const BackgroundLayoutGroupRenderer: React.FC<RendererProps> = ({ 
  params, 
  onEditItem,
  // æ³¨æ„ï¼šæ²¡æœ‰ onAddItem å‚æ•°
}) => {
  const layouts = parseBackgroundLayoutGroup(params);

  return (
    <ParamCard title="3DèƒŒæ™¯å¸ƒå±€ç»„">
      {layouts.map((layout, index) => (
        <ParamRow
          key={index}
          label={`å¸ƒå±€ ${index + 1}`}
          value={layout.id}
          onEdit={() => onEditItem?.(index)}
        />
      ))}
      {/* æ³¨æ„ï¼šæ²¡æœ‰ AddItemButton */}
    </ParamCard>
  );
};
```

**App.tsx ä¸æä¾›æ·»åŠ å›è°ƒ**:
```tsx
// æ¸²æŸ“å‘½ä»¤è¯¦æƒ…æ—¶ä¸ä¸º backgroundlayoutgroup æ·»åŠ  onAddItem
if (card.type === 'backgroundgroup') {
  props.onEditItem = (index: number) => handleEditGroupItem(card, index, 'background');
  props.onAddItem = () => handleAddGroupItem(card, 'background');
} else if (card.type === 'backgroundlayoutgroup') {
  props.onEditItem = (index: number) => handleEditGroupItem(card, index, 'backgroundlayout');
  // æ²¡æœ‰ onAddItemï¼
}
```

**è§£æå™¨å¤„ç†ç©º ID** (`parserHelpers.ts`):
```tsx
export function parseBackgroundLayoutGroup(params: Record<string, any>): BackgroundLayoutItem[] {
  const layoutsParam = params.layouts || params.backgroundlayouts || '';
  
  return layoutsParam.split('|||')
    .map((segment: string) => {
      const idMatch = segment.match(/id=([\w]*)/);  // å…è®¸ç©ºå­—ç¬¦ä¸²
      return {
        id: idMatch ? (idMatch[1] || '(æœªè®¾ç½®)') : '(æœªè®¾ç½®)'  // æ˜¾ç¤ºå ä½ç¬¦
      };
    })
    .filter((item: BackgroundLayoutItem) => item.id !== undefined);
}
```

#### å…³é”®å·®å¼‚å¯¹æ¯”

| ç‰¹æ€§ | backgroundgroup | backgroundlayoutgroup |
|------|----------------|---------------------|
| ç”¨é€” | å®šä¹‰ 3D èƒŒæ™¯èµ„æº | å¸ƒå±€ç°æœ‰ 3D èƒŒæ™¯ |
| æ·»åŠ åŠŸèƒ½ | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| AddItemButton | âœ… æ˜¾ç¤º | âŒ éšè— |
| onAddItem å›è°ƒ | âœ… æä¾› | âŒ ä¸æä¾› |
| ID é€‰æ‹© | æ–‡æœ¬è¾“å…¥ | ä¸‹æ‹‰é€‰æ‹©ï¼ˆæ¥è‡ª backgroundgroupï¼‰ |
| ç©º ID å¤„ç† | æ˜¾ç¤ºç©ºå­—ç¬¦ä¸² | æ˜¾ç¤º "(æœªè®¾ç½®)" å ä½ç¬¦ |
| éªŒè¯æœºåˆ¶ | æ— ç‰¹æ®ŠéªŒè¯ | å¿…é¡»é€‰æ‹©æœ‰æ•ˆ IDï¼ˆonValidateï¼‰ |

#### ç”¨æˆ·å·¥ä½œæµç¨‹

1. **å®šä¹‰èƒŒæ™¯**ï¼šåœ¨ `backgroundgroup` ä¸­æ·»åŠ  3D èƒŒæ™¯
   ```
   [backgroundgroup backgrounds=[background id=bg_room_01 src=...]]
   ```

2. **å¸ƒå±€èƒŒæ™¯**ï¼šåœ¨ `backgroundlayoutgroup` ä¸­é€‰æ‹©å¹¶å¸ƒå±€
   ```
   [backgroundlayoutgroup layouts=[backgroundlayout id=bg_room_01]]
   ```

3. **ç¼–è¾‘å¸ƒå±€**ï¼šç‚¹å‡»å¸ƒå±€é¡¹ â†’ ä»ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©å…¶ä»–èƒŒæ™¯ â†’ ä¿å­˜

---

## æ¨¡å¼ä¸‰ï¼šå¤æ‚ JSON å‚æ•°ç¼–è¾‘å™¨

### é€‚ç”¨åœºæ™¯
- å‚æ•°æ˜¯å¤æ‚çš„åµŒå¥— JSON å¯¹è±¡
- åŸå§‹å‘½ä»¤ä¸­ JSON ä½¿ç”¨è½¬ä¹‰æ ¼å¼ `\{...\}`
- éœ€è¦åºåˆ—åŒ–/ååºåˆ—åŒ–å¤„ç†

### ä»£è¡¨å‘½ä»¤
- `camerasetting`: `[camerasetting setting=\{"focalLength":30,...\} clip=...]`

### å®ç°ç‰¹ç‚¹

#### 1. ç¼–è¾‘å™¨å®ç° (`CameraSettingEditor.tsx`)
```tsx
// æ•°æ®æ¥å£
interface CameraSettingData {
  focalLength?: number;
  nearClipPlane?: number;
  farClipPlane?: number;
  transform?: {
    position?: { x: number; y: number; z: number };
    rotation?: { x: number; y: number; z: number };
    scale?: { x: number; y: number; z: number };
  };
  dofSetting?: {
    active: boolean;
    focalPoint?: number;
    fNumber?: number;
    maxBlurSpread?: number;
  };
}

// è§£æï¼šç§»é™¤è½¬ä¹‰ç¬¦
const parseSetting = (settingStr: string | undefined): CameraSettingData => {
  if (!settingStr) return defaultSettings;
  
  try {
    const cleanedSetting = settingStr.replace(/\\/g, ''); // ç§»é™¤ \{ â†’ {
    return JSON.parse(cleanedSetting);
  } catch (e) {
    console.error('è§£æç›¸æœºè®¾ç½®å¤±è´¥:', e);
    return {};
  }
};

// åºåˆ—åŒ–ï¼šæ·»åŠ è½¬ä¹‰ç¬¦
const serializeSetting = (data: CameraSettingData): string => {
  const json = JSON.stringify(data);
  return json.replace(/\{/g, '\\{').replace(/\}/g, '\\}'); // { â†’ \{
};

export const CameraSettingEditor: React.FC<Props> = ({ card, onChange }) => {
  const [setting, setSetting] = useState<CameraSettingData>(() => 
    parseSetting(card.params.setting)
  );
  const [isInitialized, setIsInitialized] = useState(false);

  // åˆå§‹åŒ–æ ‡è®°
  useEffect(() => {
    setIsInitialized(true);
  }, []);

  // ç›‘å¬å¤–éƒ¨å˜åŒ–ï¼ˆç”¨æˆ·ç›´æ¥ç¼–è¾‘åŸå§‹å‘½ä»¤ï¼‰
  useEffect(() => {
    if (isInitialized) {
      const currentSettingStr = serializeSetting(setting);
      if (card.params.setting !== currentSettingStr) {
        const newSetting = parseSetting(card.params.setting);
        setSetting(newSetting);
      }
    }
  }, [card.params.setting, isInitialized]);

  // ç›‘å¬å†…éƒ¨å˜åŒ–ï¼ˆç”¨æˆ·ç¼–è¾‘è¡¨å•ï¼‰
  useEffect(() => {
    if (isInitialized) {
      const updatedCard = {
        ...card,
        params: {
          ...card.params,
          setting: serializeSetting(setting), // åºåˆ—åŒ–ä¸ºè½¬ä¹‰æ ¼å¼
        },
      };
      onChange(updatedCard);
    }
  }, [setting, isInitialized]);

  const handleFieldChange = (key: string, value: any) => {
    setSetting(prev => {
      const newSetting = { ...prev };
      
      // å¤„ç†åµŒå¥—å­—æ®µ
      if (key === 'position' || key === 'rotation' || key === 'scale') {
        newSetting.transform = { ...newSetting.transform, [key]: value };
      } else if (key === 'dofActive') {
        newSetting.dofSetting = { ...newSetting.dofSetting, active: value };
      } else {
        (newSetting as any)[key] = value;
      }
      
      return newSetting;
    });
  };

  return <FormEditor sections={sections} onChange={handleFieldChange} />;
};
```

#### 2. æ¸²æŸ“å™¨è§£æ (`parserHelpers.ts`)
```tsx
export function parseCameraSetting(params: Record<string, any>): CameraSettingInfo | null {
  if (!params.setting) return null;
  
  try {
    // ç§»é™¤è½¬ä¹‰ç¬¦
    const cleanedSetting = params.setting.replace(/\\/g, '');
    return JSON.parse(cleanedSetting);
  } catch (e) {
    console.error('è§£æç›¸æœºè®¾ç½®å¤±è´¥:', e);
    return null;
  }
}
```

#### 3. å‘½ä»¤æ–‡æœ¬æ›´æ–° (`App.tsx`)
```tsx
const updateCommandText = (originalCard: CommandCard, editedCard: CommandCard): string => {
  // å¯¹äºåŒ…å«å¤æ‚ JSON å‚æ•°çš„å‘½ä»¤ï¼Œç›´æ¥é‡å»ºæ•´ä¸ªå‘½ä»¤
  if (editedCard.params.setting !== undefined && 
      editedCard.params.setting !== originalCard.params.setting) {
    console.log('ğŸ“ setting å‚æ•°å˜æ›´ï¼Œé‡å»ºæ•´ä¸ªå‘½ä»¤');
    return generateFullCommandText(editedCard);
  }
  
  // ... å…¶ä»–å‚æ•°çš„å¤„ç†
};

const generateFullCommandText = (card: CommandCard): string => {
  const parts: string[] = [];
  parts.push(`[${card.type}`);
  
  // ç›´æ¥ä½¿ç”¨ params çš„å€¼ï¼ˆå·²ç»æ˜¯è½¬ä¹‰æ ¼å¼ï¼‰
  for (const [key, value] of Object.entries(card.params)) {
    if (value !== null && value !== undefined && value !== '') {
      parts.push(`${key}=${value}`);
    }
  }
  
  // æ·»åŠ  clip å‚æ•°
  if (card.clip) {
    const clipObj = { /* ... */ };
    let clipJson = JSON.stringify(clipObj);
    clipJson = clipJson.replace(/^\{/, '\\{').replace(/\}$/, '\\}');
    parts.push(`clip=${clipJson}`);
  }
  
  parts.push(']');
  return parts.join(' ');
};
```

### æ•°æ®æµ
```
åŸå§‹å‘½ä»¤: setting=\{...\}
    â†“
Parser: ç§»é™¤è½¬ä¹‰ â†’ params.setting = \{...\} (ä¿ç•™è½¬ä¹‰)
    â†“
Renderer: ç§»é™¤è½¬ä¹‰ â†’ æ˜¾ç¤º {...}
    â†“
Editor: parseSetting ç§»é™¤è½¬ä¹‰ â†’ ç¼–è¾‘ {...} â†’ serializeSetting æ·»åŠ è½¬ä¹‰ â†’ \{...\}
    â†“
Save: generateFullCommandText â†’ setting=\{...\}
    â†“
æ–°çš„åŸå§‹å‘½ä»¤: setting=\{...\}
```

### å…³é”®ç‚¹
1. **è½¬ä¹‰å¤„ç†è§„åˆ™**ï¼š
   - Parser è§£ææ—¶ï¼šä¿ç•™è½¬ä¹‰åœ¨ `params` ä¸­
   - Renderer æ˜¾ç¤ºæ—¶ï¼šç§»é™¤è½¬ä¹‰åè§£æ
   - Editor ç¼–è¾‘æ—¶ï¼šæ¥æ”¶æ—¶ç§»é™¤è½¬ä¹‰ï¼Œä¿å­˜æ—¶æ·»åŠ è½¬ä¹‰
   - Save ä¿å­˜æ—¶ï¼šç›´æ¥ä½¿ç”¨å¸¦è½¬ä¹‰çš„å€¼

2. **åŒå‘åŒæ­¥**ï¼š
   - ä½¿ç”¨ `isInitialized` é¿å…åˆå§‹åŒ–æ—¶çš„å¾ªç¯æ›´æ–°
   - ç›‘å¬å¤–éƒ¨ `card.params.setting` çš„å˜åŒ–
   - ç›‘å¬å†…éƒ¨ `setting` çš„å˜åŒ–

3. **å®Œæ•´é‡å»ºå‘½ä»¤**ï¼š
   - å¤æ‚ JSON å‚æ•°ä¸é€‚åˆæ­£åˆ™æ›¿æ¢
   - ä½¿ç”¨ `generateFullCommandText` é‡å»ºæ•´ä¸ªå‘½ä»¤
   - ä¿è¯ clip ç­‰å‚æ•°ä¸ä¸¢å¤±

---

## å¿«é€Ÿä¿®æ”¹æŒ‡å—

æœ¬ç« èŠ‚æä¾›å¿«é€Ÿä¿®æ”¹ä»»æ„å‘½ä»¤çš„å®Œæ•´æ­¥éª¤æ¸…å•ï¼ŒåŒ…æ‹¬ç¼–è¾‘å™¨ã€æ¸²æŸ“å™¨ã€å¡ç‰‡æ ‡é¢˜ç­‰æ‰€æœ‰éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†ã€‚

### ä¿®æ”¹å‘½ä»¤çš„å®Œæ•´æ­¥éª¤

#### ç¬¬ä¸€æ­¥ï¼šç¡®å®šå‘½ä»¤ç±»å‹å’Œæ¨¡å¼

```
ç¡®è®¤å‘½ä»¤å±äºå“ªç§æ¨¡å¼ï¼š
â–¡ æ¨¡å¼ä¸€ï¼šç®€å•å‚æ•°ï¼ˆå¦‚ fade, actormotionï¼‰
â–¡ æ¨¡å¼äºŒï¼šGroup ç±»å‘½ä»¤ï¼ˆå¦‚ backgroundgroupï¼‰
â–¡ æ¨¡å¼ä¸‰ï¼šå¤æ‚ JSON å‚æ•°ï¼ˆå¦‚ camerasettingï¼‰
```

#### ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ç¼–è¾‘å™¨ (CommandEditors/)

**ä½ç½®**: `editor2/src/components/CommandEditors/XxxEditor/XxxEditor.tsx`

**æ¨¡å¼ä¸€ç¤ºä¾‹** (ç®€å•å‚æ•°):
```tsx
// 1. åˆ›å»ºç¼–è¾‘å™¨æ–‡ä»¶
export const XxxEditor: React.FC<XxxEditorProps> = ({ card, onChange }) => {
  // 2. å®šä¹‰çŠ¶æ€ï¼ˆåªåŒ…å«éœ€è¦ç¼–è¾‘çš„æ ¸å¿ƒå‚æ•°ï¼‰
  const [formData, setFormData] = useState({
    param1: card.params.param1 || '',
    param2: card.params.param2 || 0,
  });

  // 3. å®æ—¶åŒæ­¥åˆ°çˆ¶ç»„ä»¶
  useEffect(() => {
    onChange({
      ...card,
      params: { ...card.params, ...formData },
    });
  }, [formData]);

  // 4. è¿”å›è¡¨å•ï¼ˆä¸ä½¿ç”¨ form-section åŒ…è£¹ï¼‰
  return (
    <div className="form-container">
      <div className="form-field">
        <label className="form-label">å‚æ•°1</label>
        <input
          type="text"
          className="form-input"
          value={formData.param1}
          onChange={(e) => setFormData({ ...formData, param1: e.target.value })}
        />
        <div className="form-help-text">å‚æ•°è¯´æ˜</div>
      </div>
    </div>
  );
};
```

**å¸¦ä¸‹æ‹‰é€‰æ‹©çš„é«˜çº§ç¤ºä¾‹**:
```tsx
// 1. æ·»åŠ APIåŠ è½½é€»è¾‘
const [options, setOptions] = useState<any[]>([]);
const [loading, setLoading] = useState(false);

useEffect(() => {
  const loadOptions = async () => {
    setLoading(true);
    try {
      const response = await fetch('http://localhost:5000/api/resources/...');
      const data = await response.json();
      if (data.success) setOptions(data.data);
    } catch (err) {
      console.error('åŠ è½½å¤±è´¥:', err);
    } finally {
      setLoading(false);
    }
  };
  loadOptions();
}, []);

// 2. å¹³æ»‘é™çº§ï¼šAPIä¸å¯ç”¨æ—¶ä½¿ç”¨æ–‡æœ¬è¾“å…¥
{options.length > 0 ? (
  <select
    className="form-select"
    value={formData.param}
    onChange={(e) => setFormData({ ...formData, param: e.target.value })}
  >
    <option value="">è¯·é€‰æ‹©...</option>
    {options.map((opt) => (
      <option key={opt.id} value={opt.value}>{opt.label}</option>
    ))}
  </select>
) : (
  <input type="text" className="form-input" value={formData.param} />
)}
```

**æ³¨å†Œç¼–è¾‘å™¨** (`CommandEditors/index.ts`):
```tsx
// 1. å¯¼å…¥ç¼–è¾‘å™¨
import { XxxEditor } from './XxxEditor/XxxEditor';

// 2. æ·»åŠ åˆ°æ˜ å°„è¡¨
const editorMap: Record<string, EditorComponent> = {
  'xxx': XxxEditor,
  // ...
};

// 3. å¯¼å‡º
export { XxxEditor };
```

#### ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹æ¸²æŸ“å™¨ (App/renderers/)

**ä½ç½®**: `editor2/src/components/App/renderers/XxxRenderer.tsx`

```tsx
// 1. åˆ›å»ºæ¸²æŸ“å™¨æ–‡ä»¶
import React from 'react';
import { ParamRow, ParamCard } from './ParamRow';

interface Props {
  params: Record<string, any>;
  onEdit?: () => void;
}

// 2. å®ç°æ¸²æŸ“é€»è¾‘ï¼ˆåªæ˜¾ç¤ºæ ¸å¿ƒå‚æ•°ï¼‰
const XxxRenderer: React.FC<Props> = ({ params, onEdit }) => (
  <ParamCard title="XXXè®¾ç½®" onEdit={onEdit}>
    <ParamRow label="å‚æ•°1" value={params.param1} />
    <ParamRow label="å‚æ•°2" value={params.param2} />
    {/* å¯ä»¥ä½¿ç”¨ formatter æ ¼å¼åŒ–æ˜¾ç¤º */}
    <ParamRow 
      label="æ—¶é—´" 
      value={params.duration} 
      formatter={(v) => `${v}s`}
    />
  </ParamCard>
);

export default XxxRenderer;
```

**æ³¨å†Œæ¸²æŸ“å™¨** (`App/renderers/index.ts`):
```tsx
// 1. å¯¼å…¥æ¸²æŸ“å™¨
import XxxRenderer from './XxxRenderer';

// 2. æ·»åŠ åˆ°æ˜ å°„è¡¨
const rendererMap: Record<string, React.FC<any>> = {
  'xxx': XxxRenderer,
  // ...
};
```

#### ç¬¬å››æ­¥ï¼šä¿®æ”¹å¡ç‰‡æ ‡é¢˜ (types/command-card.ts)

**ä½ç½®**: `editor2/src/types/command-card.ts` çš„ `generateCardTitle` å‡½æ•°

```tsx
// åœ¨ switch è¯­å¥ä¸­æ·»åŠ  case
case CommandType.Xxx:
case 'xxx':
  // æå–å…³é”®å‚æ•°æ˜¾ç¤ºåœ¨æ ‡é¢˜ä¸­
  return `XXX: ${params.param1} - ${params.param2}`;
  
// å¸¦é»˜è®¤å€¼å¤„ç†
case CommandType.Xxx:
  const param1 = params.param1 || 'æœªçŸ¥';
  const param2 = params.param2 !== undefined ? params.param2 : '?';
  return `XXX: ${param1} â†’ ${param2}`;
```

#### ç¬¬äº”æ­¥ï¼šæµ‹è¯•æ¸…å•

```
â–¡ åŠ è½½æ–‡ä»¶åå¡ç‰‡æ­£ç¡®æ˜¾ç¤º
â–¡ å¡ç‰‡æ ‡é¢˜æ˜¾ç¤ºå…³é”®å‚æ•°
â–¡ ç‚¹å‡»å¡ç‰‡æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
â–¡ ç‚¹å‡»ç¼–è¾‘æŒ‰é’®æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
â–¡ ç¼–è¾‘å‚æ•°åå¡ç‰‡å®æ—¶æ›´æ–°
â–¡ ä¿å­˜ååŸå§‹å‘½ä»¤æ­£ç¡®æ›´æ–°
â–¡ å¦‚æœ‰ä¸‹æ‹‰é€‰æ‹©ï¼Œæµ‹è¯•APIå¯ç”¨å’Œä¸å¯ç”¨ä¸¤ç§æƒ…å†µ
â–¡ å¦‚æœ‰ä¾èµ–å…¶ä»–å‘½ä»¤ï¼Œæµ‹è¯•æ˜¯å¦æ­£ç¡®æå–æ•°æ®
```

### å¸¸è§ä¿®æ”¹åœºæ™¯é€ŸæŸ¥

#### åœºæ™¯1: åªä¿®æ”¹æ˜¾ç¤ºï¼Œä¸ä¿®æ”¹ç¼–è¾‘åŠŸèƒ½

```
ä¿®æ”¹æ–‡ä»¶ï¼š
âœ“ XxxRenderer.tsx - ä¿®æ”¹æ˜¾ç¤ºçš„å‚æ•°
âœ“ command-card.ts - ä¿®æ”¹å¡ç‰‡æ ‡é¢˜
```

#### åœºæ™¯2: å»æ‰æ—¶é—´è½´æ˜¾ç¤º

```
ä¿®æ”¹æ–‡ä»¶ï¼š
âœ“ XxxEditor.tsx - åˆ é™¤æ—¶é—´è½´ç›¸å…³çš„form-field
âœ“ XxxRenderer.tsx - åˆ é™¤æ—¶é—´ç›¸å…³çš„ParamRow
æ³¨æ„ï¼šä¸è¦ä¿®æ”¹clipæ•°æ®æœ¬èº«ï¼Œåªæ˜¯ä¸æ˜¾ç¤ºè€Œå·²
```

#### åœºæ™¯3: æ·»åŠ Database APIä¸‹æ‹‰é€‰æ‹©

```
ä¿®æ”¹æ–‡ä»¶ï¼š
âœ“ XxxEditor.tsx - æ·»åŠ APIåŠ è½½é€»è¾‘å’Œä¸‹æ‹‰é€‰æ‹©
å‚è€ƒï¼šActorMotionEditor.tsx
éœ€è¦ï¼š
  - useState ç®¡ç†options, loading, error
  - useEffect åŠ è½½APIæ•°æ®
  - æ¡ä»¶æ¸²æŸ“ï¼šselect vs input
  - é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
```

#### åœºæ™¯4: ä»å…¶ä»–å‘½ä»¤æå–å¯é€‰é¡¹

```
ä¿®æ”¹æ–‡ä»¶ï¼š
âœ“ App.tsx - æš´éœ²cardsæ•°æ®åˆ°window.__editorCards
âœ“ XxxEditor.tsx - ä»window.__editorCardsæå–æ•°æ®
å‚è€ƒï¼šActorMotionEditor.tsx (æå–actorgroup)
ç¤ºä¾‹ï¼š
  useEffect(() => {
    const cards = (window as any).__editorCards || [];
    // éå†cardsæå–éœ€è¦çš„æ•°æ®
  }, []);
```

#### åœºæ™¯5: å¤ç”¨ç°æœ‰ç¼–è¾‘å™¨

```
ä¿®æ”¹æ–‡ä»¶ï¼š
âœ“ CommandEditors/index.ts - æ˜ å°„è¡¨ä¸­æŒ‡å‘åŒä¸€ç¼–è¾‘å™¨
ç¤ºä¾‹ï¼š
  'actorfacialmotion': ActorMotionEditor,  // å¤ç”¨
```

### æ–‡ä»¶ä½ç½®é€ŸæŸ¥è¡¨

| åŠŸèƒ½ | æ–‡ä»¶è·¯å¾„ | ä½œç”¨ |
|------|---------|------|
| ç¼–è¾‘å™¨ | `CommandEditors/XxxEditor/` | ç¼–è¾‘å‘½ä»¤å‚æ•° |
| ç¼–è¾‘å™¨æ³¨å†Œ | `CommandEditors/index.ts` | æ³¨å†Œç¼–è¾‘å™¨åˆ°ç³»ç»Ÿ |
| æ¸²æŸ“å™¨ | `App/renderers/XxxRenderer.tsx` | æ˜¾ç¤ºå‘½ä»¤è¯¦æƒ… |
| æ¸²æŸ“å™¨æ³¨å†Œ | `App/renderers/index.ts` | æ³¨å†Œæ¸²æŸ“å™¨åˆ°ç³»ç»Ÿ |
| å¡ç‰‡æ ‡é¢˜ | `types/command-card.ts` | ç”Ÿæˆå¡ç‰‡æ ‡é¢˜æ–‡å­— |
| å‘½ä»¤å›¾æ ‡ | `types/command-card.ts` | è®¾ç½®å¡ç‰‡å›¾æ ‡emoji |
| å‘½ä»¤é¢œè‰² | `types/command-card.ts` | è®¾ç½®å¡ç‰‡é¢œè‰²ç±»åˆ« |
| å¡ç‰‡æ ·å¼ | `Card.css` | å¡ç‰‡é¢œè‰²æ ·å¼å®šä¹‰ |
| è¡¨å•æ ·å¼ | `FormEditor/FormEditor.css` | ç¼–è¾‘å™¨è¡¨å•æ ·å¼ |

### ä¿®æ”¹åçš„æäº¤æ£€æŸ¥æ¸…å•

```
â–¡ æ‰€æœ‰ä¿®æ”¹çš„æ–‡ä»¶å·²ä¿å­˜
â–¡ TypeScriptæ²¡æœ‰ç¼–è¯‘é”™è¯¯
â–¡ ç¼–è¾‘å™¨å·²åœ¨index.tsä¸­æ³¨å†Œ
â–¡ æ¸²æŸ“å™¨å·²åœ¨index.tsä¸­æ³¨å†Œ
â–¡ å¡ç‰‡æ ‡é¢˜å·²æ›´æ–°
â–¡ å·²æµ‹è¯•ç¼–è¾‘å’Œæ˜¾ç¤ºåŠŸèƒ½
â–¡ å·²æµ‹è¯•å¹³æ»‘é™çº§ï¼ˆå¦‚é€‚ç”¨ï¼‰
â–¡ å·²æ›´æ–°æ–‡æ¡£ï¼ˆå¦‚éœ€è¦ï¼‰
```

---

## å…³é”®å®ç°è¦ç‚¹

### 0. é€šç”¨éªŒè¯æœºåˆ¶

æ‰€æœ‰éœ€è¦éªŒè¯å¿…å¡«å­—æ®µçš„ç¼–è¾‘å™¨éƒ½ä½¿ç”¨ç»Ÿä¸€çš„éªŒè¯æ¨¡å¼ï¼š

#### éªŒè¯æ¥å£è§„èŒƒ

```tsx
interface EditorProps {
  card: CommandCard;
  onChange: (updatedCard: CommandCard, isValid?: boolean) => void;
}
```

#### ç¼–è¾‘å™¨å®ç°

ç¼–è¾‘å™¨å†…éƒ¨è´Ÿè´£éªŒè¯å¿…å¡«å­—æ®µï¼Œå¹¶é€šè¿‡ `onChange` å›è°ƒé€šçŸ¥çˆ¶ç»„ä»¶ï¼š

```tsx
export const XxxEditor: React.FC<EditorProps> = ({ card, onChange }) => {
  const [formData, setFormData] = useState({
    id: card.params.id || '',
    motion: card.params.motion || '',
  });

  useEffect(() => {
    // éªŒè¯å¿…å¡«å­—æ®µ
    const isValid = !!(formData.id?.trim() && formData.motion?.trim());
    
    // æ„å»ºæ›´æ–°åçš„å¡ç‰‡å¹¶ä¼ é€’éªŒè¯çŠ¶æ€
    const updatedCard = {
      ...card,
      params: { ...card.params, ...formData }
    };
    
    onChange(updatedCard, isValid);
  }, [formData]);
  
  // ...
};
```

#### çˆ¶ç»„ä»¶å¤„ç†

**App.tsx** æ¥æ”¶éªŒè¯çŠ¶æ€å¹¶æ§åˆ¶ä¿å­˜æŒ‰é’®ï¼š

```tsx
// çŠ¶æ€ç®¡ç†
const [canSaveEdit, setCanSaveEdit] = useState(true);
const [canSaveGroupItem, setCanSaveGroupItem] = useState(true);

// å¤„ç†ç¼–è¾‘å™¨å˜åŒ–
const handleEditorChange = (updatedCard: CommandCard, isValid?: boolean) => {
  setEditedCard(updatedCard);
  if (isValid !== undefined) {
    setCanSaveEdit(isValid);
  }
};

// æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†æ—¶é‡ç½®éªŒè¯çŠ¶æ€
const handleCardEdit = (card: CommandCard) => {
  setEditingCard(card);
  setEditedCard(card);
  setCanSaveEdit(true);  // é‡ç½®ä¸ºtrue
  setShowEditDialog(true);
};

// ä¼ é€’ç»™å¯¹è¯æ¡†
<EditDialog
  canSave={canSaveEdit}  // æ§åˆ¶ä¿å­˜æŒ‰é’®
  onSave={handleSaveEdit}
>
  {renderEditor()}
</EditDialog>
```

#### EditDialog å®ç°

```tsx
interface EditDialogProps {
  canSave?: boolean;  // é»˜è®¤ä¸º true
  onSave: () => void;
  // ...
}

export const EditDialog: React.FC<EditDialogProps> = ({ 
  canSave = true, 
  onSave,
  // ...
}) => {
  return (
    <div className="dialog">
      <button 
        className="save-btn"
        onClick={onSave}
        disabled={!canSave}
        title={!canSave ? "è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ" : ""}
      >
        ä¿å­˜
      </button>
    </div>
  );
};
```

#### æ ·å¼æ”¯æŒ

**EditDialog.css**:
```css
.save-btn:disabled {
  background-color: #cccccc;
  cursor: not-drop;
  opacity: 0.6;
}

.save-btn:not(:disabled):hover {
  background-color: #45a049;
}
```

#### éªŒè¯æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | æ—§æ¨¡å¼ï¼ˆå·²åºŸå¼ƒï¼‰ | æ–°æ¨¡å¼ï¼ˆé€šç”¨ï¼‰ |
|------|----------------|--------------|
| éªŒè¯ä½ç½® | App.tsx é›†ä¸­å¼ useEffect | å„ç¼–è¾‘å™¨å†…éƒ¨ |
| éªŒè¯è§¦å‘ | ç›‘å¬ editedCard å˜åŒ– | ç›‘å¬ formData å˜åŒ– |
| é€šçŸ¥æ–¹å¼ | æ—  | onChange å›è°ƒçš„ isValid å‚æ•° |
| ç”¨æˆ·ä½“éªŒ | Alert å¼¹çª—æç¤º | ä¿å­˜æŒ‰é’®ç¦ç”¨ + tooltip |
| æ‰©å±•æ€§ | éœ€ä¿®æ”¹ App.tsx | åªéœ€ç¼–è¾‘å™¨å®ç°æ¥å£ |
| éªŒè¯é€»è¾‘ | é›†ä¸­åœ¨çˆ¶ç»„ä»¶ | åˆ†æ•£åœ¨å„ç¼–è¾‘å™¨ |

#### å…³é”®è¦ç‚¹

1. **å®æ—¶éªŒè¯**ï¼šåœ¨ useEffect ä¸­éªŒè¯ï¼Œä¸ç­‰åˆ°ä¿å­˜æ—¶æ‰æ£€æŸ¥
2. **ç¦ç”¨æŒ‰é’®**ï¼šé€šè¿‡ disabled å±æ€§è€Œé alert æç¤º
3. **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰ç¼–è¾‘å™¨ä½¿ç”¨ç›¸åŒçš„ onChange ç­¾å
4. **åˆ†æ•£èŒè´£**ï¼šéªŒè¯é€»è¾‘å½’å±äºå„ç¼–è¾‘å™¨ï¼Œçˆ¶ç»„ä»¶åªç®¡ç†çŠ¶æ€
5. **é‡ç½®çŠ¶æ€**ï¼šæ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†æ—¶é‡ç½® canSave ä¸º true

#### å¸¸è§é”™è¯¯

âŒ **é”™è¯¯ç¤ºä¾‹**ï¼šåœ¨ App.tsx ä¸­é›†ä¸­éªŒè¯
```tsx
// å·²åºŸå¼ƒçš„æ¨¡å¼ï¼Œä¸è¦ä½¿ç”¨ï¼
useEffect(() => {
  if (editedCard?.type === 'actormotion') {
    setCanSaveEdit(!!(editedCard.params.id && editedCard.params.motion));
  }
}, [editedCard]);
```

âœ… **æ­£ç¡®ç¤ºä¾‹**ï¼šåœ¨ç¼–è¾‘å™¨ä¸­éªŒè¯å¹¶é€šçŸ¥
```tsx
// åœ¨ ActorMotionEditor.tsx ä¸­
useEffect(() => {
  const isValid = !!(formData.id?.trim() && formData.motion?.trim());
  onChange({ ...card, params: formData }, isValid);
}, [formData]);
```

---

### 1. æ·»åŠ åŠŸèƒ½çš„å®ç°ï¼ˆä»…é™æ¨¡å¼äºŒï¼‰

æ¨¡å¼äºŒï¼ˆGroup ç±»å‘½ä»¤ï¼‰ç‰¹æœ‰çš„æ·»åŠ åŠŸèƒ½ï¼š

#### å®Œæ•´å®ç°æ­¥éª¤

1. **æ¸²æŸ“å™¨æ¥æ”¶ `onAddItem` å›è°ƒ**
```tsx
const XXXGroupRenderer: React.FC<RendererProps> = ({ 
  params, 
  onEditItem, 
  onAddItem  // å¿…é¡»æ¥æ”¶
}) => {
  // ...
  {onAddItem && <AddItemButton label="æ·»åŠ XXX" onClick={onAddItem} />}
}
```

2. **App.tsx æä¾›æ·»åŠ å›è°ƒ**
```tsx
if (card.type === 'xxxgroup') {
  props.onAddItem = () => handleAddGroupItem(card, 'xxx');
}
```

3. **æ·»åŠ æ—¶ä½¿ç”¨ç‰¹æ®Šç´¢å¼• `-2`**
```tsx
const handleAddGroupItem = (card, itemType) => {
  setEditingCard(card);
  setEditingItemIndex(-2);  // å…³é”®ï¼š-2 è¡¨ç¤ºæ·»åŠ æ¨¡å¼
  setEditingItemData(defaultData);
};
```

4. **ä¿å­˜é€»è¾‘åŒºåˆ†æ·»åŠ å’Œç¼–è¾‘**
```tsx
if (editingItemIndex === -2) {
  items.push(editingItemData);  // æ·»åŠ 
} else {
  items[editingItemIndex] = editingItemData;  // ç¼–è¾‘
}
```

5. **å¯¹è¯æ¡†æ ‡é¢˜åŠ¨æ€æ˜¾ç¤º**
```tsx
title={
  editingItemIndex === -2 
    ? `æ·»åŠ ${type}` 
    : `ç¼–è¾‘${type} #${editingItemIndex + 1}`
}
```

### 1. çŠ¶æ€ç®¡ç†

#### æ¨¡å¼ä¸€ & æ¨¡å¼ä¸‰ï¼šç›´æ¥ç¼–è¾‘ card
```tsx
const [formData, setFormData] = useState(card);

useEffect(() => {
  onChange(formData);
}, [formData]);
```

#### æ¨¡å¼äºŒï¼šç‹¬ç«‹ç¼–è¾‘çŠ¶æ€
```tsx
const [editingCard, setEditingCard] = useState<CommandCard | null>(null);
const [editingItemIndex, setEditingItemIndex] = useState<number>(-1);
const [editingItemData, setEditingItemData] = useState<Record<string, any>>({});
```

### 2. å®æ—¶åŒæ­¥æœºåˆ¶

#### ç¼–è¾‘å™¨ â†’ å¡ç‰‡
```tsx
// ä½¿ç”¨ useEffect ç›‘å¬æ•°æ®å˜åŒ–
useEffect(() => {
  onChange(updatedCard);
}, [formData]); // æˆ– [setting]
```

#### åŸå§‹å‘½ä»¤ â†’ ç¼–è¾‘å™¨ï¼ˆåŒå‘åŒæ­¥ï¼‰
```tsx
// ç›‘å¬å¤–éƒ¨ card å˜åŒ–
useEffect(() => {
  if (isInitialized) {
    const newSetting = parseSetting(card.params.setting);
    setSetting(newSetting);
  }
}, [card.params.setting, isInitialized]);
```

### 3. å‘½ä»¤æ–‡æœ¬æ›´æ–°ç­–ç•¥

| æƒ…å†µ | ç­–ç•¥ | åŸå›  |
|------|------|------|
| ç®€å•å‚æ•°å˜åŒ– | æ­£åˆ™æ›¿æ¢ | æ•ˆç‡é«˜ï¼Œä¿ç•™æ ¼å¼ |
| ç±»å‹å˜åŒ– | å®Œæ•´é‡å»º | ç¡®ä¿å‘½ä»¤å¤´æ­£ç¡® |
| å¤æ‚ JSON å‚æ•°å˜åŒ– | å®Œæ•´é‡å»º | é¿å…æ­£åˆ™è½¬ä¹‰é—®é¢˜ |
| Group é¡¹å˜åŒ– | å®Œæ•´é‡å»º | åµŒå¥—ç»“æ„å¤æ‚ |

### 4. Clip å‚æ•°ä¿ç•™

æ‰€æœ‰æ›´æ–°ç­–ç•¥éƒ½å¿…é¡»ä¿ç•™ `clip` å‚æ•°ï¼š
, backgroundsetting | backgroundgroup | camerasetting |
| æ·»åŠ åŠŸèƒ½ | ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆAddItemButtonï¼‰ | ä¸æ”¯æŒ |
| ç¼–è¾‘æ¨¡å¼æ ‡è¯† | N/A | `editingItemIndex` (-2=æ·»åŠ , >=0=ç¼–è¾‘) | N/A |
| ä¾èµ–éªŒè¯ | âœ… ç¦ç”¨é€‰æ‹©æ¡† | N/A
const clipMatch = originalCommand.match(/clip=\\?\{[^}]+\\?\}/);
const clipParam = clipMatch ? ` ${clipMatch[0]}` : '';

// æ–¹å¼2: ä½¿ç”¨ generateFullCommandText
if (card.clip) {
  const clipObj = { /* ... */ };
  let clipJson = JSON.stringify(clipObj);
  clipJson = clipJson.replace(/^\{/, '\\{').replace(/\}$/, '\\}');
  parts.push(`clip=${clipJson}`);
}
```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: ç¼–è¾‘åå¡ç‰‡æ¶ˆå¤±

**åŸå› **: 
- ç”Ÿæˆçš„å‘½ä»¤æ–‡æœ¬æ— æ³•è¢« Parser æ­£ç¡®è§£æ
- JSON å‚æ•°æ ¼å¼é”™è¯¯ï¼ˆè½¬ä¹‰ç¬¦å¤„ç†ä¸å½“ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `serializeSetting` æ˜¯å¦æ­£ç¡®æ·»åŠ è½¬ä¹‰
2. ç¡®ä¿ `generateFullCommandText` è¾“å‡ºæ ¼å¼æ­£ç¡®
3. åœ¨ä¿å­˜åæ·»åŠ æ—¥å¿—ï¼ŒéªŒè¯ `raw_line` çš„å€¼

```tsx
console.log('ä¿å­˜åçš„å‘½ä»¤:', updatedCard.raw_line);
```

### é—®é¢˜2: ç¼–è¾‘ä¸ç”Ÿæ•ˆï¼ŒåŸå§‹å‘½ä»¤æœªæ›´æ–°

**åŸå› **:
- `updateCommandText` çš„æ­£åˆ™æ›¿æ¢å¤±è´¥
- è½¬ä¹‰å­—ç¬¦å¯¼è‡´åŒ¹é…ä¸ä¸Š

**è§£å†³æ–¹æ¡ˆ**:
å¯¹äºå¤æ‚å‚æ•°ï¼Œä½¿ç”¨å®Œæ•´é‡å»ºï¼š
```tsx
if (editedCard.params.setting !== originalCard.params.setting) {
  return generateFullCommandText(editedCard);
}
```

### é—®é¢˜3: Clip å‚æ•°ä¸¢å¤±

**åŸå› **:
- é‡å»ºå‘½ä»¤æ—¶å¿˜è®°æ·»åŠ  clip
- æå– clip çš„æ­£åˆ™è¡¨è¾¾å¼ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**:
```tsx
// 1. ä»åŸå§‹å‘½ä»¤æå–
const clipMatch = originalCommand.match(/clip=\\?\{[^}]+\\?\}/);

// 2. æˆ–ä» card.clip é‡å»º
if (card.clip) {
  const clipObj = { /* æ‰€æœ‰ clip å­—æ®µ */ };
  let clipJson = JSON.stringify(clipObj);
  clipJson = clipJson.replace(/^\{/, '\\{').replace(/\}$/, '\\}');
  parts.push(`clip=${clipJson}`);
}
```

### é—®é¢˜4: ç¼–è¾‘å™¨æ˜¾ç¤ºé”™è¯¯æ•°æ®

**åŸå› **:
- æ²¡æœ‰æ­£ç¡®ç§»é™¤è½¬ä¹‰ç¬¦å°±è§£æ JSON
- åŒå‘åŒæ­¥å‡ºç°å¾ªç¯æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**:
```tsx
// 1. è§£æå‰ç§»é™¤è½¬ä¹‰
const cleanedSetting = settingStr.replace(/\\/g, '');
const data = JSON.parse(cleanedSetting);

// 2. ä½¿ç”¨ isInitialized é¿å…å¾ªç¯
const [isInitialized, setIsInitialized] = useState(false);
useEffect(() => { setIsInitialized(true); }, []);

useEffect(() => {
  if (isInitialized) {
    // ... åŒæ­¥é€»è¾‘
  }
}, [setting, isInitialized]);
```

### é—®é¢˜5: æ¸²æŸ“å™¨ä¸æ˜¾ç¤ºæ•°æ®

**åŸå› **:
- `parseXXX` å‡½æ•°æ²¡æœ‰ç§»é™¤è½¬ä¹‰ç¬¦
- è¿”å› null å¯¼è‡´å¡ç‰‡ä¸æ¸²æŸ“

**è§£å†³æ–¹æ¡ˆ**:
```tsx
export function parseCameraSetting(params: Record<string, any>): CameraSettingInfo | null {
  if (!params.setting) return null;
  
  try {
    const cleanedSetting = params.setting.replace(/\\/g, ''); // å…³é”®æ­¥éª¤
    return JSON.parse(cleanedSetting);
  } catch (e) {
    console.error('è§£æå¤±è´¥:', e);
    return null; // ç¡®ä¿é”™è¯¯æ—¶è¿”å› null
  }
}
```

---

## å¼€å‘æ–°å‘½ä»¤ç¼–è¾‘å™¨çš„æ£€æŸ¥æ¸…å•

### 1. ç¡®å®šç¼–è¾‘æ¨¡å¼
- [ ] ç¡®å®šå‘½ä»¤å±äºå“ªç§æ¨¡å¼ï¼ˆç®€å•å‚æ•° / Group é¡¹ / å¤æ‚ JSONï¼‰
- [ ] æŸ¥çœ‹ç±»ä¼¼å‘½ä»¤çš„å®ç°ä½œä¸ºå‚è€ƒ
- [ ] ç¡®å®šæ˜¯å¦éœ€è¦æ·»åŠ åŠŸèƒ½ï¼ˆä»… Group ç±»å‘½ä»¤ï¼‰

### 2. åˆ›å»ºç¼–è¾‘å™¨ç»„ä»¶
- [ ] å®šä¹‰æ•°æ®æ¥å£ï¼ˆå¦‚æœæ˜¯æ¨¡å¼ä¸‰ï¼‰
- [ ] å®ç° parseSetting / serializeSettingï¼ˆæ¨¡å¼ä¸‰ï¼‰
- [ ] è®¾ç½®çŠ¶æ€å’Œåˆå§‹åŒ–
- [ ] å®ç°åŒå‘åŒæ­¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] åˆ›å»ºè¡¨å•é…ç½® (FormSection[])

### 3. æ›´æ–°æ¸²æŸ“å™¨
- [ ] å®ç° parseXXX å‡½æ•°
- [ ] ç§»é™¤ JSON å‚æ•°çš„è½¬ä¹‰ç¬¦
- [ ] è¿”å›æ­£ç¡®çš„æ•°æ®ç»“æ„
- [ ] æ·»åŠ  AddItemButtonï¼ˆä»… Group ç±»å‘½ä»¤ï¼‰
- [ ] æ¥æ”¶å¹¶ä½¿ç”¨ onAddItem å›è°ƒ
- [ ] é”™è¯¯å¤„ç†è¿”å› null

### 4.å®ç° handleAddGroupItemï¼ˆä»… Group ç±»å‘½ä»¤ï¼‰
- [ ] åœ¨ renderCommandDetails ä¸­ä¼ é€’ onAddItem å›è°ƒ
- [ ] ä¿å­˜é€»è¾‘ä¸­å¤„ç† editingItemIndex === -2ï¼ˆæ·»åŠ æ¨¡å¼ï¼‰
- [ ]  æ›´æ–° App.tsx
- [ ] æ·»åŠ ç¼–è¾‘é€»è¾‘ï¼ˆæ¨¡å¼äºŒéœ€è¦ä¸“é—¨çš„ä¿å­˜å‡½æ•°ï¼‰
- [ ] æ›´æ–° updateCommandTextï¼ˆæ¨¡å¼ä¸‰éœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
- [ ] ç¡®ä¿ clip å‚æ•°è¢«ä¿ç•™
- [ ] æµ‹è¯•å¡ç‰‡åˆ—è¡¨å’Œé€‰ä¸­çŠ¶æ€æ›´æ–°

### 5. æµ‹è¯•ï¼ˆæ¨¡å¼ä¸‰ï¼‰
- [ ] æ·»åŠ æ–°é¡¹ â†’ æˆåŠŸæ·»åŠ å¹¶æ˜¾ç¤ºï¼ˆæ¨¡å¼äºŒï¼‰
- [ ] æ·»åŠ æŒ‰é’®æ˜¾ç¤ºæ­£ç¡®ï¼ˆæ¨¡å¼äºŒï¼‰
- [ ] å¯¹è¯æ¡†æ ‡é¢˜åŒºåˆ†"æ·»åŠ "å’Œ"ç¼–è¾‘"ï¼ˆæ¨¡å¼äºŒï¼‰
- [ ] ç¼–è¾‘å‚æ•° â†’ å¡ç‰‡æ­£æ–‡å®æ—¶æ›´æ–°
- [ ] ä¿å­˜å â†’ åŸå§‹å‘½ä»¤æ­£ç¡®æ›´æ–°
- [ ] ç›´æ¥ç¼–è¾‘åŸå§‹å‘½ä»¤ â†’ ç¼–è¾‘å™¨è¡¨å•å®æ—¶æ›´æ–°
- [ ] Clip å‚æ•°ä¸ä¸¢å¤±
- [ ] å¡ç‰‡ä¸æ¶ˆå¤±
- [ ] åˆ·æ–°åæ•°æ®æ­£ç¡®

---

## æ€»ç»“

### ä¸‰ç§æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | æ¨¡å¼ä¸€ | æ¨¡å¼äºŒ | æ¨¡å¼ä¸‰ |
|------|--------|--------|--------|
| çŠ¶æ€ç®¡ç† | ç›´æ¥ä¿®æ”¹ card | ç‹¬ç«‹ç¼–è¾‘çŠ¶æ€ | å†…éƒ¨æ•°æ®ç»“æ„ + card |
| å®æ—¶åŒæ­¥ | å•å‘ (ç¼–è¾‘å™¨ â†’ card) | ä¿å­˜æ—¶åŒæ­¥ | åŒå‘åŒæ­¥ |
| å‘½ä»¤æ›´æ–° | æ­£åˆ™æ›¿æ¢ | å®Œæ•´é‡å»º | å®Œæ•´é‡å»º |
| è½¬ä¹‰å¤„ç† | ä¸æ¶‰åŠ | éƒ¨åˆ†æ¶‰åŠ (transform) | æ ¸å¿ƒé€»è¾‘ |
| å¤æ‚åº¦ | ä½ | ä¸­ | é«˜ |
| ç¤ºä¾‹ | fade, actormotion | backgroundgroup | camerasetting |
| æ·»åŠ åŠŸèƒ½ | ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆAddItemButtonï¼‰ | ä¸æ”¯æŒ |
| ç¼–è¾‘æ¨¡å¼æ ‡è¯† | N/A | `editingItemIndex` (-2=æ·»åŠ , >=0=ç¼–è¾‘) | N/A |

### å…³é”®åŸåˆ™

1. **è½¬ä¹‰æ ¼å¼ä¸€è‡´æ€§**: 
   - åŸå§‹å‘½ä»¤: `\{...\}`
   - params å­˜å‚¨: `\{...\}`
   - è§£æ/æ¸²æŸ“: ç§»é™¤è½¬ä¹‰ `{...}`
   - åºåˆ—åŒ–: æ·»åŠ è½¬ä¹‰ `\{...\}`

2. **é¿å…å¾ªç¯æ›´æ–°**:
   - ä½¿ç”¨ `isInitialized` æ ‡è®°
   - æ¯”è¾ƒå€¼æ˜¯å¦çœŸçš„æ”¹å˜
   - åˆç†è®¾ç½® useEffect ä¾èµ–

3. **æ·»åŠ åŠŸèƒ½è§„èŒƒ** (ä»…æ¨¡å¼äºŒ):
   - ä½¿ç”¨ `editingItemIndex = -2` æ ‡è¯†æ·»åŠ æ¨¡å¼
   - æä¾›åˆç†çš„é»˜è®¤å€¼
   - å¯¹è¯æ¡†æ ‡é¢˜åŠ¨æ€æ˜¾ç¤º
   - æ¸²æŸ“å™¨å¿…é¡»æ¥æ”¶å¹¶ä½¿ç”¨ `onAddItem` å›è°ƒ
   - ä¿å­˜é€»è¾‘ä¸­åŒºåˆ†æ·»åŠ å’Œç¼–è¾‘

5. **ä¿ç•™æ‰€æœ‰å‚æ•°**:
   - æ›´æ–°æ—¶å¿…é¡»ä¿ç•™ clip
   - Group å‘½ä»¤ä¿ç•™å…¶ä»–å­—æ®µ
   - é‡å»ºæ—¶åŒ…å«æ‰€æœ‰å¿…è¦å‚æ•°

4. **é”™è¯¯å¤„ç†**:
   - JSON è§£æå¤±è´¥è¿”å›é»˜è®¤å€¼æˆ– null
   - æ·»åŠ  console.log å¸®åŠ©è°ƒè¯•
   - ç¡®ä¿é”™è¯¯ä¸ä¼šå¯¼è‡´å¡ç‰‡æ¶ˆå¤±

---
3  
**æœ€åæ›´æ–°**: 2026-01-13  
**ç»´æŠ¤è€…**: Editor2 å¼€å‘å›¢é˜Ÿ

**æ›´æ–°æ—¥å¿—**:
- v1.4 (2026-01-13): æ·»åŠ "é€šç”¨éªŒè¯æœºåˆ¶"ç« èŠ‚å’Œ"BackgroundLayoutGroupï¼ˆåªè¯»é€‰æ‹©å™¨ï¼‰"ç‰¹æ®Šæ¡ˆä¾‹è¯´æ˜ï¼Œè¡¥å……æ¨¡å¼äºŒä»£è¡¨å‘½ä»¤
- v1.3 (2026-01-12): æ·»åŠ BackgroundSettingå®ä¾‹ï¼Œæ›´æ–°ä¾èµ–éªŒè¯æœºåˆ¶ï¼ˆç¦ç”¨è€Œéé™çº§ï¼‰ï¼Œå»é™¤ç¼–è¾‘å™¨è¾¹æ¡†
- v1.2 (2026-01-12): æ·»åŠ ActorMotionå®ä¾‹ï¼Œæ–°å¢"å¿«é€Ÿä¿®æ”¹æŒ‡å—"ç« èŠ‚
- v1.1 (2026-01-12): æ·»åŠ Fadeå®ä¾‹ï¼Œæ›´æ–°ä»£è¡¨å‘½ä»¤åˆ—è¡¨
- v1.0 (2026-01-04): åˆå§‹ç‰ˆæœ¬
