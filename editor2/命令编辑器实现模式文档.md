# å‘½ä»¤ç¼–è¾‘å™¨å®ç°æ¨¡å¼æ–‡æ¡£

æœ¬æ–‡æ¡£æ€»ç»“äº† Editor2 é¡¹ç›®ä¸­ä¸åŒç±»å‹å‘½ä»¤çš„ç¼–è¾‘å™¨å®ç°æ¨¡å¼ï¼Œç”¨äºæŒ‡å¯¼æœªæ¥æ–°å‘½ä»¤ç¼–è¾‘å™¨çš„å¼€å‘ã€‚

---

## ç›®å½•
1. [ç¼–è¾‘å™¨åˆ†ç±»](#ç¼–è¾‘å™¨åˆ†ç±»)
2. [æ¨¡å¼ä¸€ï¼šç®€å•å‚æ•°ç¼–è¾‘å™¨](#æ¨¡å¼ä¸€ç®€å•å‚æ•°ç¼–è¾‘å™¨)
3. [æ¨¡å¼äºŒï¼šGroup é¡¹ç¼–è¾‘å™¨](#æ¨¡å¼äºŒgroup-é¡¹ç¼–è¾‘å™¨)
4. [æ¨¡å¼ä¸‰ï¼šå¤æ‚ JSON å‚æ•°ç¼–è¾‘å™¨](#æ¨¡å¼ä¸‰å¤æ‚-json-å‚æ•°ç¼–è¾‘å™¨)
5. [å…³é”®å®ç°è¦ç‚¹](#å…³é”®å®ç°è¦ç‚¹)
6. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)

---

## ç¼–è¾‘å™¨åˆ†ç±»

æ ¹æ®å‘½ä»¤çš„å¤æ‚åº¦å’Œç¼–è¾‘æ–¹å¼ï¼Œç¼–è¾‘å™¨åˆ†ä¸ºä¸‰ç§æ¨¡å¼ï¼š

| æ¨¡å¼ | å‘½ä»¤ç±»å‹ | ç‰¹ç‚¹ | ä»£è¡¨å‘½ä»¤ |
|------|----------|------|----------|
| æ¨¡å¼ä¸€ | ç®€å•å‚æ•°å‘½ä»¤ | ç›´æ¥ç¼–è¾‘ params å­—æ®µï¼Œå®æ—¶åŒæ­¥ | `dialogue`, `message`, `narration` |
| æ¨¡å¼äºŒ | Group ç±»å‘½ä»¤ | ç¼–è¾‘ group å†…çš„å•ä¸ªé¡¹ï¼Œä¸“é—¨çš„ä¿å­˜é€»è¾‘ | `backgroundgroup`, `actorgroup`, `actorlayoutgroup` |
| æ¨¡å¼ä¸‰ | å¤æ‚ JSON å‚æ•°å‘½ä»¤ | ç¼–è¾‘è½¬ä¹‰çš„ JSON å‚æ•°ï¼Œéœ€è¦åºåˆ—åŒ–/ååºåˆ—åŒ– | `camerasetting` |

---

## æ¨¡å¼ä¸€ï¼šç®€å•å‚æ•°ç¼–è¾‘å™¨

### é€‚ç”¨åœºæ™¯
- å‘½ä»¤åªæœ‰ç®€å•çš„æ–‡æœ¬ã€æ•°å­—ç­‰å‚æ•°
- å‚æ•°ç›´æ¥å­˜å‚¨åœ¨ `params` å¯¹è±¡ä¸­
- ä¸æ¶‰åŠåµŒå¥—ç»“æ„æˆ– JSON åºåˆ—åŒ–

### ä»£è¡¨å‘½ä»¤
- `dialogue` / `message` / `narration`

### å®ç°ç‰¹ç‚¹

#### 1. ç¼–è¾‘å™¨å®ç° (`DialogueEditor.tsx`)
```tsx
export const DialogueEditor: React.FC<DialogueEditorProps> = ({ card, onChange }) => {
  const [formData, setFormData] = useState(card);

  // å®æ—¶åŒæ­¥ï¼šformData å˜åŒ–æ—¶ç«‹å³é€šçŸ¥çˆ¶ç»„ä»¶
  useEffect(() => {
    onChange(formData);
  }, [formData]);

  const handleFieldChange = (key: string, value: any) => {
    setFormData(prev => ({
      ...prev,
      params: {
        ...prev.params,
        [key]: value,
      },
    }));
  };

  // ä½¿ç”¨ FormEditor æ¸²æŸ“è¡¨å•
  return <FormEditor sections={sections} onChange={handleFieldChange} />;
};
```

#### 2. ä¿å­˜é€»è¾‘ (`App.tsx`)
```tsx
const handleSaveEdit = () => {
  if (!editingCard || !editedCard) return;
  
  // ä½¿ç”¨ updateCommandText æ™ºèƒ½æ›´æ–°åŸå§‹å‘½ä»¤
  const newRawLine = updateCommandText(editingCard, editedCard);
  
  const updatedCard: CommandCard = {
    ...editedCard,
    isModified: true,
    raw_line: newRawLine,
  };
  
  // æ›´æ–°å¡ç‰‡åˆ—è¡¨
  setCards(prev => prev.map(c => c.id === updatedCard.id ? updatedCard : c));
  
  // æ›´æ–°é€‰ä¸­å¡ç‰‡
  if (selectedCard?.id === updatedCard.id) {
    setSelectedCard(updatedCard);
  }
};
```

#### 3. å‘½ä»¤æ–‡æœ¬æ›´æ–° (`updateCommandText`)
```tsx
// å¯¹äºç®€å•å‚æ•°ï¼Œä½¿ç”¨æ­£åˆ™æ›¿æ¢
for (const [key, value] of Object.entries(editedCard.params)) {
  if (value !== originalCard.params[key]) {
    const oldValue = originalCard.params[key];
    if (oldValue !== undefined && oldValue !== null) {
      const escapedOldValue = String(oldValue).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`${key}=${escapedOldValue}`, 'g');
      updatedText = updatedText.replace(regex, `${key}=${value}`);
    }
  }
}
```

### æ•°æ®æµ
```
ç”¨æˆ·è¾“å…¥ â†’ handleFieldChange â†’ setFormData â†’ useEffect â†’ onChange(formData)
       â†’ editedCard æ›´æ–° â†’ ç‚¹å‡»ä¿å­˜ â†’ updateCommandText â†’ raw_line æ›´æ–°
       â†’ å¡ç‰‡æ›´æ–° â†’ æ¸²æŸ“å™¨æ˜¾ç¤ºæ–°å€¼
```

---

## æ¨¡å¼äºŒï¼šGroup é¡¹ç¼–è¾‘å™¨

### é€‚ç”¨åœºæ™¯
- å‘½ä»¤åŒ…å«å¤šä¸ªå­é¡¹ï¼ˆå¦‚å¤šä¸ªèƒŒæ™¯ã€å¤šä¸ªè§’è‰²ï¼‰
- éœ€è¦å•ç‹¬ç¼–è¾‘ã€æ·»åŠ ã€åˆ é™¤å­é¡¹
- å­é¡¹æ ¼å¼ä¸º `[itemtype ...]` çš„åµŒå¥—ç»“æ„

### ä»£è¡¨å‘½ä»¤
- `backgroundgroup`: `[backgroundgroup backgrounds=[background id=... src=...] ...]`
- `actorgroup`: `[actorgroup actors=[actor id=... body=...] ...]`
- `actorlayoutgroup`: `[actorlayoutgroup layouts=[actorlayout id=... transform=\{...\}] ...]`

### å®ç°ç‰¹ç‚¹

#### 1. å­é¡¹ç¼–è¾‘å™¨ (`BackgroundItemEditor.tsx`)
```tsx
const BackgroundItemEditor: React.FC<Props> = ({ id, src, onChange }) => {
  const [localData, setLocalData] = useState({ id, src });

  // å®æ—¶é€šçŸ¥çˆ¶ç»„ä»¶
  useEffect(() => {
    onChange(localData.id, localData.src);
  }, [localData]);

  return (
    <div>
      <input value={localData.id} onChange={(e) => setLocalData({...localData, id: e.target.value})} />
      <input value={localData.src} onChange={(e) => setLocalData({...localData, src: e.target.value})} />
    </div>
  );
};
```

#### 2. ç¼–è¾‘æµç¨‹ (`App.tsx`)
```tsx
// æ­¥éª¤1: ç‚¹å‡»ç¼–è¾‘æŒ‰é’®ï¼Œæ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
const handleEditGroupItem = (card: CommandCard, itemIndex: number, itemType: string) => {
  if (itemType === 'background') {
    const backgrounds = parseBackgroundGroup(card.params);
    const bg = backgrounds[itemIndex];
    setEditingCard(card);
    setEditingItemIndex(itemIndex);
    setEditingItemData({ id: bg.id, src: bg.src });
  }
};

// æ­¥éª¤2: ä¿å­˜ç¼–è¾‘
const saveBackgroundGroupItem = () => {
  const backgrounds = parseBackgroundGroup(editingCard.params);
  
  // æ›´æ–°æˆ–æ·»åŠ é¡¹
  if (editingItemIndex === -2) {
    backgrounds.push(editingItemData); // æ·»åŠ æ¨¡å¼
  } else {
    backgrounds[editingItemIndex] = editingItemData; // ç¼–è¾‘æ¨¡å¼
  }
  
  // é‡æ–°ç”Ÿæˆå‘½ä»¤å­—ç¬¦ä¸²
  const backgroundStrs = backgrounds.map(bg => 
    `[background id=${bg.id} src=${bg.src}]`
  );
  
  // æ›´æ–° params.backgroundsï¼ˆå†…éƒ¨æ ¼å¼ï¼‰
  const newBackgroundsParam = backgrounds
    .map(bg => `id=${bg.id} src=${bg.src}`)
    .join(' ||| ');
  
  // æ›´æ–°å¡ç‰‡
  const updatedCard: CommandCard = {
    ...editingCard,
    params: { ...editingCard.params, backgrounds: newBackgroundsParam },
    isModified: true,
    raw_line: updateBackgroundGroupText(editingCard, backgroundStrs),
  };
  
  // æ›´æ–°åˆ—è¡¨å’Œé€‰ä¸­çŠ¶æ€
  setCards(prev => prev.map(c => c.id === updatedCard.id ? updatedCard : c));
  if (selectedCard?.id === updatedCard.id) {
    setSelectedCard(updatedCard);
  }
};
```

#### 3. å‘½ä»¤æ–‡æœ¬é‡å»º (`updateBackgroundGroupText`)
```tsx
const updateBackgroundGroupText = (card: CommandCard, backgroundStrs: string[]): string => {
  // å®Œå…¨é‡å»ºå‘½ä»¤ï¼Œä¿ç•™ clip ç­‰å…¶ä»–å‚æ•°
  const newBackgroundParams = backgroundStrs.map(bg => `backgrounds=${bg}`).join(' ');
  
  // æå– clip å‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰
  const clipMatch = card.raw_line.match(/clip=\\?\{[^}]+\\?\}/);
  const clipParam = clipMatch ? ` ${clipMatch[0]}` : '';
  
  return `[backgroundgroup ${newBackgroundParams}${clipParam}]`;
};
```

### æ•°æ®æµ

#### ç¼–è¾‘æµç¨‹
```
ç‚¹å‡»ç¼–è¾‘ â†’ handleEditGroupItem â†’ æ‰“å¼€å¯¹è¯æ¡† â†’ ç¼–è¾‘æ•°æ®
       â†’ setEditingItemData â†’ ç‚¹å‡»ä¿å­˜ â†’ saveBackgroundGroupItem
       â†’ é‡å»ºæ•´ä¸ªå‘½ä»¤ â†’ raw_line æ›´æ–° â†’ å¡ç‰‡æ›´æ–° â†’ æ¸²æŸ“å™¨æ˜¾ç¤º
```

#### æ·»åŠ æµç¨‹
```
ç‚¹å‡»æ·»åŠ æŒ‰é’® â†’ handleAddGroupItem â†’ è®¾ç½®é»˜è®¤æ•°æ® â†’ æ‰“å¼€å¯¹è¯æ¡†
            â†’ ç¼–è¾‘æ•°æ® â†’ ç‚¹å‡»ä¿å­˜ â†’ saveBackgroundGroupItem (index=-2)
            â†’ æ·»åŠ åˆ°æ•°ç»„ â†’ é‡å»ºå‘½ä»¤ â†’ æ›´æ–°å¡ç‰‡
```

### 4. æ·»åŠ æŒ‰é’®å®ç°

#### æ¸²æŸ“å™¨ä¸­æ·»åŠ æŒ‰é’® (`BackgroundGroupRenderer.tsx`)
```tsx
import { ParamRow, ParamCard, AddItemButton } from './ParamRow';

const BackgroundGroupRenderer: React.FC<RendererProps> = ({ 
  params, 
  onEditItem, 
  onAddItem  // æ¥æ”¶æ·»åŠ å›è°ƒ
}) => {
  const backgrounds = parseBackgroundGroup(params);
  
  return (
    <>
      {backgrounds.map((bg, index) => (
        <ParamCard key={index} title="èƒŒæ™¯è®¾ç½®" onEdit={() => onEditItem(index)}>
          <ParamRow label="èƒŒæ™¯ID" value={bg.id} />
          <ParamRow label="èµ„æºè·¯å¾„" value={bg.src} />
        </ParamCard>
      ))}
      
      {/* æ·»åŠ æŒ‰é’® - åªæœ‰æä¾›äº†å›è°ƒæ‰æ˜¾ç¤º */}
      {onAddItem && <AddItemButton label="æ·»åŠ èƒŒæ™¯è®¾ç½®" onClick={onAddItem} />}
    </>
  );
};
```

#### æ·»åŠ æŒ‰é’®ç»„ä»¶ (`ParamRow.tsx`)
```tsx
/**
 * æ·»åŠ é¡¹æŒ‰é’®ç»„ä»¶ - é€šç”¨äºæ‰€æœ‰ Group ç±»å‹å‘½ä»¤
 */
export const AddItemButton: React.FC<{ 
  label: string; 
  onClick: () => void 
}> = ({ label, onClick }) => {
  return (
    <div className="detail-section">
      <button 
        className="detail-add-btn" 
        onClick={onClick}
        title={label}
      >
        + {label}
      </button>
    </div>
  );
};
```

#### App.tsx ä¸­è¿æ¥æ·»åŠ é€»è¾‘
```tsx
// æ·»åŠ æ–°é¡¹
const handleAddGroupItem = (card: CommandCard, itemType: string) => {
  setEditingCard(card);
  setEditingItemIndex(-2); // ä½¿ç”¨ -2 è¡¨ç¤ºæ·»åŠ æ¨¡å¼ï¼ˆåŒºåˆ†ç¼–è¾‘æ¨¡å¼ï¼‰
  
  // æ ¹æ®ç±»å‹è®¾ç½®é»˜è®¤å€¼
  if (itemType === 'background') {
    setEditingItemData({ id: '', src: '' });
  } else if (itemType === 'actor') {
    setEditingItemData({ id: '', body: '', face: '', hair: '' });
  } else if (itemType === 'actorlayout') {
    setEditingItemData({ 
      id: '', 
      transform: {
        position: { x: 0, y: 0, z: 0 },
        rotation: { x: 0, y: 0, z: 0 },
        scale: { x: 1, y: 1, z: 1 },
      }
    });
  }
  // æœªæ¥å¯ä»¥æ‰©å±•å…¶ä»–ç±»å‹
};

// æ¸²æŸ“å‘½ä»¤è¯¦æƒ…æ—¶ä¼ é€’æ·»åŠ å›è°ƒ
const renderCommandDetails = (card: CommandCard) => {
  const Renderer = getRenderer(card.type);
  const props: any = {
    params: card.params,
    onEdit: () => handleCardEdit(card),
  };
  
  // ä¸º group ç±»å‹å‘½ä»¤æ·»åŠ é€šç”¨çš„é¡¹ç¼–è¾‘å’Œæ·»åŠ å›è°ƒ
  if (card.type === 'backgroundgroup') {
    props.onEditItem = (index: number) => handleEditGroupItem(card, index, 'background');
    props.onAddItem = () => handleAddGroupItem(card, 'background');  // æ·»åŠ å›è°ƒ
  } else if (card.type === 'actorgroup') {
    props.onEditItem = (index: number) => handleEditGroupItem(card, index, 'actor');
    props.onAddItem = () => handleAddGroupItem(card, 'actor');
  } else if (card.type === 'actorlayoutgroup') {
    props.onEditItem = (index: number) => handleEditGroupItem(card, index, 'actorlayout');
    props.onAddItem = () => handleAddGroupItem(card, 'actorlayout');
  }
  
  return <Renderer {...props} />;
};
```

#### ä¿å­˜é€»è¾‘ä¸­å¤„ç†æ·»åŠ æ¨¡å¼
```tsx
const saveBackgroundGroupItem = () => {
  if (!editingCard) return;
  
  const backgrounds = parseBackgroundGroup(editingCard.params);
  
  // æ·»åŠ æ¨¡å¼ï¼ˆindex = -2ï¼‰
  if (editingItemIndex === -2) {
    backgrounds.push({
      id: editingItemData.id || '',
      src: editingItemData.src || '',
    });
  }
  // ç¼–è¾‘æ¨¡å¼ï¼ˆindex >= 0ï¼‰
  else if (editingItemIndex >= 0 && editingItemIndex < backgrounds.length) {
    backgrounds[editingItemIndex] = {
      id: editingItemData.id || '',
      src: editingItemData.src || '',
    };
  } else {
    return;
  }
  
  // ... é‡å»ºå‘½ä»¤çš„é€»è¾‘ç›¸åŒ
};
```

#### å¯¹è¯æ¡†æ ‡é¢˜åŠ¨æ€æ˜¾ç¤º
```tsx
<EditDialog
  title={
    editingItemIndex === -2 
      ? `æ·»åŠ ${getItemTypeName(editingCard.type)}`  // æ·»åŠ æ¨¡å¼
      : `ç¼–è¾‘${getItemTypeName(editingCard.type)} #${editingItemIndex + 1}`  // ç¼–è¾‘æ¨¡å¼
  }
  isOpen={true}
  onClose={handleCancelGroupItem}
  onSave={handleSaveGroupItem}
>
  {renderGroupItemEditor(editingCard.type)}
</EditDialog>
```

### å…³é”®ç‚¹
1. **ä¸ç›´æ¥ä¿®æ”¹ card**ï¼šç¼–è¾‘æ—¶ä½¿ç”¨ç‹¬ç«‹çš„ `editingItemData` çŠ¶æ€
2. **å®Œæ•´é‡å»ºå‘½ä»¤**ï¼šä¸ä½¿ç”¨æ­£åˆ™æ›¿æ¢ï¼Œè€Œæ˜¯é‡æ–°ç”Ÿæˆæ•´ä¸ªå‘½ä»¤å­—ç¬¦ä¸²
3. **ä¿ç•™å…¶ä»–å‚æ•°**ï¼šé‡å»ºæ—¶è¦ä¿ç•™ `clip` ç­‰å…¶ä»–å‚æ•°
4. **å†…éƒ¨æ ¼å¼**ï¼š`params.backgrounds` ä½¿ç”¨ `|||` åˆ†éš”ï¼Œæ–¹ä¾¿è§£æ

---

## æ¨¡å¼ä¸‰ï¼šå¤æ‚ JSON å‚æ•°ç¼–è¾‘å™¨

### é€‚ç”¨åœºæ™¯
- å‚æ•°æ˜¯å¤æ‚çš„åµŒå¥— JSON å¯¹è±¡
- åŸå§‹å‘½ä»¤ä¸­ JSON ä½¿ç”¨è½¬ä¹‰æ ¼å¼ `\{...\}`
- éœ€è¦åºåˆ—åŒ–/ååºåˆ—åŒ–å¤„ç†

### ä»£è¡¨å‘½ä»¤
- `camerasetting`: `[camerasetting setting=\{"focalLength":30,...\} clip=...]`

### å®ç°ç‰¹ç‚¹

#### 1. ç¼–è¾‘å™¨å®ç° (`CameraSettingEditor.tsx`)
```tsx
// æ•°æ®æ¥å£
interface CameraSettingData {
  focalLength?: number;
  nearClipPlane?: number;
  farClipPlane?: number;
  transform?: {
    position?: { x: number; y: number; z: number };
    rotation?: { x: number; y: number; z: number };
    scale?: { x: number; y: number; z: number };
  };
  dofSetting?: {
    active: boolean;
    focalPoint?: number;
    fNumber?: number;
    maxBlurSpread?: number;
  };
}

// è§£æï¼šç§»é™¤è½¬ä¹‰ç¬¦
const parseSetting = (settingStr: string | undefined): CameraSettingData => {
  if (!settingStr) return defaultSettings;
  
  try {
    const cleanedSetting = settingStr.replace(/\\/g, ''); // ç§»é™¤ \{ â†’ {
    return JSON.parse(cleanedSetting);
  } catch (e) {
    console.error('è§£æç›¸æœºè®¾ç½®å¤±è´¥:', e);
    return {};
  }
};

// åºåˆ—åŒ–ï¼šæ·»åŠ è½¬ä¹‰ç¬¦
const serializeSetting = (data: CameraSettingData): string => {
  const json = JSON.stringify(data);
  return json.replace(/\{/g, '\\{').replace(/\}/g, '\\}'); // { â†’ \{
};

export const CameraSettingEditor: React.FC<Props> = ({ card, onChange }) => {
  const [setting, setSetting] = useState<CameraSettingData>(() => 
    parseSetting(card.params.setting)
  );
  const [isInitialized, setIsInitialized] = useState(false);

  // åˆå§‹åŒ–æ ‡è®°
  useEffect(() => {
    setIsInitialized(true);
  }, []);

  // ç›‘å¬å¤–éƒ¨å˜åŒ–ï¼ˆç”¨æˆ·ç›´æ¥ç¼–è¾‘åŸå§‹å‘½ä»¤ï¼‰
  useEffect(() => {
    if (isInitialized) {
      const currentSettingStr = serializeSetting(setting);
      if (card.params.setting !== currentSettingStr) {
        const newSetting = parseSetting(card.params.setting);
        setSetting(newSetting);
      }
    }
  }, [card.params.setting, isInitialized]);

  // ç›‘å¬å†…éƒ¨å˜åŒ–ï¼ˆç”¨æˆ·ç¼–è¾‘è¡¨å•ï¼‰
  useEffect(() => {
    if (isInitialized) {
      const updatedCard = {
        ...card,
        params: {
          ...card.params,
          setting: serializeSetting(setting), // åºåˆ—åŒ–ä¸ºè½¬ä¹‰æ ¼å¼
        },
      };
      onChange(updatedCard);
    }
  }, [setting, isInitialized]);

  const handleFieldChange = (key: string, value: any) => {
    setSetting(prev => {
      const newSetting = { ...prev };
      
      // å¤„ç†åµŒå¥—å­—æ®µ
      if (key === 'position' || key === 'rotation' || key === 'scale') {
        newSetting.transform = { ...newSetting.transform, [key]: value };
      } else if (key === 'dofActive') {
        newSetting.dofSetting = { ...newSetting.dofSetting, active: value };
      } else {
        (newSetting as any)[key] = value;
      }
      
      return newSetting;
    });
  };

  return <FormEditor sections={sections} onChange={handleFieldChange} />;
};
```

#### 2. æ¸²æŸ“å™¨è§£æ (`parserHelpers.ts`)
```tsx
export function parseCameraSetting(params: Record<string, any>): CameraSettingInfo | null {
  if (!params.setting) return null;
  
  try {
    // ç§»é™¤è½¬ä¹‰ç¬¦
    const cleanedSetting = params.setting.replace(/\\/g, '');
    return JSON.parse(cleanedSetting);
  } catch (e) {
    console.error('è§£æç›¸æœºè®¾ç½®å¤±è´¥:', e);
    return null;
  }
}
```

#### 3. å‘½ä»¤æ–‡æœ¬æ›´æ–° (`App.tsx`)
```tsx
const updateCommandText = (originalCard: CommandCard, editedCard: CommandCard): string => {
  // å¯¹äºåŒ…å«å¤æ‚ JSON å‚æ•°çš„å‘½ä»¤ï¼Œç›´æ¥é‡å»ºæ•´ä¸ªå‘½ä»¤
  if (editedCard.params.setting !== undefined && 
      editedCard.params.setting !== originalCard.params.setting) {
    console.log('ğŸ“ setting å‚æ•°å˜æ›´ï¼Œé‡å»ºæ•´ä¸ªå‘½ä»¤');
    return generateFullCommandText(editedCard);
  }
  
  // ... å…¶ä»–å‚æ•°çš„å¤„ç†
};

const generateFullCommandText = (card: CommandCard): string => {
  const parts: string[] = [];
  parts.push(`[${card.type}`);
  
  // ç›´æ¥ä½¿ç”¨ params çš„å€¼ï¼ˆå·²ç»æ˜¯è½¬ä¹‰æ ¼å¼ï¼‰
  for (const [key, value] of Object.entries(card.params)) {
    if (value !== null && value !== undefined && value !== '') {
      parts.push(`${key}=${value}`);
    }
  }
  
  // æ·»åŠ  clip å‚æ•°
  if (card.clip) {
    const clipObj = { /* ... */ };
    let clipJson = JSON.stringify(clipObj);
    clipJson = clipJson.replace(/^\{/, '\\{').replace(/\}$/, '\\}');
    parts.push(`clip=${clipJson}`);
  }
  
  parts.push(']');
  return parts.join(' ');
};
```

### æ•°æ®æµ
```
åŸå§‹å‘½ä»¤: setting=\{...\}
    â†“
Parser: ç§»é™¤è½¬ä¹‰ â†’ params.setting = \{...\} (ä¿ç•™è½¬ä¹‰)
    â†“
Renderer: ç§»é™¤è½¬ä¹‰ â†’ æ˜¾ç¤º {...}
    â†“
Editor: parseSetting ç§»é™¤è½¬ä¹‰ â†’ ç¼–è¾‘ {...} â†’ serializeSetting æ·»åŠ è½¬ä¹‰ â†’ \{...\}
    â†“
Save: generateFullCommandText â†’ setting=\{...\}
    â†“
æ–°çš„åŸå§‹å‘½ä»¤: setting=\{...\}
```

### å…³é”®ç‚¹
1. **è½¬ä¹‰å¤„ç†è§„åˆ™**ï¼š
   - Parser è§£ææ—¶ï¼šä¿ç•™è½¬ä¹‰åœ¨ `params` ä¸­
   - Renderer æ˜¾ç¤ºæ—¶ï¼šç§»é™¤è½¬ä¹‰åè§£æ
   - Editor ç¼–è¾‘æ—¶ï¼šæ¥æ”¶æ—¶ç§»é™¤è½¬ä¹‰ï¼Œä¿å­˜æ—¶æ·»åŠ è½¬ä¹‰
   - Save ä¿å­˜æ—¶ï¼šç›´æ¥ä½¿ç”¨å¸¦è½¬ä¹‰çš„å€¼

2. **åŒå‘åŒæ­¥**ï¼š
   - ä½¿ç”¨ `isInitialized` é¿å…åˆå§‹åŒ–æ—¶çš„å¾ªç¯æ›´æ–°
   - ç›‘å¬å¤–éƒ¨ `card.params.setting` çš„å˜åŒ–
   - ç›‘å¬å†…éƒ¨ `setting` çš„å˜åŒ–

3. **å®Œæ•´é‡å»ºå‘½ä»¤**ï¼š
   - å¤æ‚ JSON å‚æ•°ä¸é€‚åˆæ­£åˆ™æ›¿æ¢
   - ä½¿ç”¨ `generateFullCommandText` é‡å»ºæ•´ä¸ªå‘½ä»¤
   - ä¿è¯ clip ç­‰å‚æ•°ä¸ä¸¢å¤±

---

## å…³é”®å®ç°è¦ç‚¹

### 0. æ·»åŠ åŠŸèƒ½çš„å®ç°ï¼ˆä»…é™æ¨¡å¼äºŒï¼‰

æ¨¡å¼äºŒï¼ˆGroup ç±»å‘½ä»¤ï¼‰ç‰¹æœ‰çš„æ·»åŠ åŠŸèƒ½ï¼š

#### å®Œæ•´å®ç°æ­¥éª¤

1. **æ¸²æŸ“å™¨æ¥æ”¶ `onAddItem` å›è°ƒ**
```tsx
const XXXGroupRenderer: React.FC<RendererProps> = ({ 
  params, 
  onEditItem, 
  onAddItem  // å¿…é¡»æ¥æ”¶
}) => {
  // ...
  {onAddItem && <AddItemButton label="æ·»åŠ XXX" onClick={onAddItem} />}
}
```

2. **App.tsx æä¾›æ·»åŠ å›è°ƒ**
```tsx
if (card.type === 'xxxgroup') {
  props.onAddItem = () => handleAddGroupItem(card, 'xxx');
}
```

3. **æ·»åŠ æ—¶ä½¿ç”¨ç‰¹æ®Šç´¢å¼• `-2`**
```tsx
const handleAddGroupItem = (card, itemType) => {
  setEditingCard(card);
  setEditingItemIndex(-2);  // å…³é”®ï¼š-2 è¡¨ç¤ºæ·»åŠ æ¨¡å¼
  setEditingItemData(defaultData);
};
```

4. **ä¿å­˜é€»è¾‘åŒºåˆ†æ·»åŠ å’Œç¼–è¾‘**
```tsx
if (editingItemIndex === -2) {
  items.push(editingItemData);  // æ·»åŠ 
} else {
  items[editingItemIndex] = editingItemData;  // ç¼–è¾‘
}
```

5. **å¯¹è¯æ¡†æ ‡é¢˜åŠ¨æ€æ˜¾ç¤º**
```tsx
title={
  editingItemIndex === -2 
    ? `æ·»åŠ ${type}` 
    : `ç¼–è¾‘${type} #${editingItemIndex + 1}`
}
```

### 1. çŠ¶æ€ç®¡ç†

#### æ¨¡å¼ä¸€ & æ¨¡å¼ä¸‰ï¼šç›´æ¥ç¼–è¾‘ card
```tsx
const [formData, setFormData] = useState(card);

useEffect(() => {
  onChange(formData);
}, [formData]);
```

#### æ¨¡å¼äºŒï¼šç‹¬ç«‹ç¼–è¾‘çŠ¶æ€
```tsx
const [editingCard, setEditingCard] = useState<CommandCard | null>(null);
const [editingItemIndex, setEditingItemIndex] = useState<number>(-1);
const [editingItemData, setEditingItemData] = useState<Record<string, any>>({});
```

### 2. å®æ—¶åŒæ­¥æœºåˆ¶

#### ç¼–è¾‘å™¨ â†’ å¡ç‰‡
```tsx
// ä½¿ç”¨ useEffect ç›‘å¬æ•°æ®å˜åŒ–
useEffect(() => {
  onChange(updatedCard);
}, [formData]); // æˆ– [setting]
```

#### åŸå§‹å‘½ä»¤ â†’ ç¼–è¾‘å™¨ï¼ˆåŒå‘åŒæ­¥ï¼‰
```tsx
// ç›‘å¬å¤–éƒ¨ card å˜åŒ–
useEffect(() => {
  if (isInitialized) {
    const newSetting = parseSetting(card.params.setting);
    setSetting(newSetting);
  }
}, [card.params.setting, isInitialized]);
```

### 3. å‘½ä»¤æ–‡æœ¬æ›´æ–°ç­–ç•¥

| æƒ…å†µ | ç­–ç•¥ | åŸå›  |
|------|------|------|
| ç®€å•å‚æ•°å˜åŒ– | æ­£åˆ™æ›¿æ¢ | æ•ˆç‡é«˜ï¼Œä¿ç•™æ ¼å¼ |
| ç±»å‹å˜åŒ– | å®Œæ•´é‡å»º | ç¡®ä¿å‘½ä»¤å¤´æ­£ç¡® |
| å¤æ‚ JSON å‚æ•°å˜åŒ– | å®Œæ•´é‡å»º | é¿å…æ­£åˆ™è½¬ä¹‰é—®é¢˜ |
| Group é¡¹å˜åŒ– | å®Œæ•´é‡å»º | åµŒå¥—ç»“æ„å¤æ‚ |

### 4. Clip å‚æ•°ä¿ç•™

æ‰€æœ‰æ›´æ–°ç­–ç•¥éƒ½å¿…é¡»ä¿ç•™ `clip` å‚æ•°ï¼š

```tsx
// æ–¹å¼1: æå– clip å‚æ•°
const clipMatch = originalCommand.match(/clip=\\?\{[^}]+\\?\}/);
const clipParam = clipMatch ? ` ${clipMatch[0]}` : '';

// æ–¹å¼2: ä½¿ç”¨ generateFullCommandText
if (card.clip) {
  const clipObj = { /* ... */ };
  let clipJson = JSON.stringify(clipObj);
  clipJson = clipJson.replace(/^\{/, '\\{').replace(/\}$/, '\\}');
  parts.push(`clip=${clipJson}`);
}
```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: ç¼–è¾‘åå¡ç‰‡æ¶ˆå¤±

**åŸå› **: 
- ç”Ÿæˆçš„å‘½ä»¤æ–‡æœ¬æ— æ³•è¢« Parser æ­£ç¡®è§£æ
- JSON å‚æ•°æ ¼å¼é”™è¯¯ï¼ˆè½¬ä¹‰ç¬¦å¤„ç†ä¸å½“ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `serializeSetting` æ˜¯å¦æ­£ç¡®æ·»åŠ è½¬ä¹‰
2. ç¡®ä¿ `generateFullCommandText` è¾“å‡ºæ ¼å¼æ­£ç¡®
3. åœ¨ä¿å­˜åæ·»åŠ æ—¥å¿—ï¼ŒéªŒè¯ `raw_line` çš„å€¼

```tsx
console.log('ä¿å­˜åçš„å‘½ä»¤:', updatedCard.raw_line);
```

### é—®é¢˜2: ç¼–è¾‘ä¸ç”Ÿæ•ˆï¼ŒåŸå§‹å‘½ä»¤æœªæ›´æ–°

**åŸå› **:
- `updateCommandText` çš„æ­£åˆ™æ›¿æ¢å¤±è´¥
- è½¬ä¹‰å­—ç¬¦å¯¼è‡´åŒ¹é…ä¸ä¸Š

**è§£å†³æ–¹æ¡ˆ**:
å¯¹äºå¤æ‚å‚æ•°ï¼Œä½¿ç”¨å®Œæ•´é‡å»ºï¼š
```tsx
if (editedCard.params.setting !== originalCard.params.setting) {
  return generateFullCommandText(editedCard);
}
```

### é—®é¢˜3: Clip å‚æ•°ä¸¢å¤±

**åŸå› **:
- é‡å»ºå‘½ä»¤æ—¶å¿˜è®°æ·»åŠ  clip
- æå– clip çš„æ­£åˆ™è¡¨è¾¾å¼ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**:
```tsx
// 1. ä»åŸå§‹å‘½ä»¤æå–
const clipMatch = originalCommand.match(/clip=\\?\{[^}]+\\?\}/);

// 2. æˆ–ä» card.clip é‡å»º
if (card.clip) {
  const clipObj = { /* æ‰€æœ‰ clip å­—æ®µ */ };
  let clipJson = JSON.stringify(clipObj);
  clipJson = clipJson.replace(/^\{/, '\\{').replace(/\}$/, '\\}');
  parts.push(`clip=${clipJson}`);
}
```

### é—®é¢˜4: ç¼–è¾‘å™¨æ˜¾ç¤ºé”™è¯¯æ•°æ®

**åŸå› **:
- æ²¡æœ‰æ­£ç¡®ç§»é™¤è½¬ä¹‰ç¬¦å°±è§£æ JSON
- åŒå‘åŒæ­¥å‡ºç°å¾ªç¯æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**:
```tsx
// 1. è§£æå‰ç§»é™¤è½¬ä¹‰
const cleanedSetting = settingStr.replace(/\\/g, '');
const data = JSON.parse(cleanedSetting);

// 2. ä½¿ç”¨ isInitialized é¿å…å¾ªç¯
const [isInitialized, setIsInitialized] = useState(false);
useEffect(() => { setIsInitialized(true); }, []);

useEffect(() => {
  if (isInitialized) {
    // ... åŒæ­¥é€»è¾‘
  }
}, [setting, isInitialized]);
```

### é—®é¢˜5: æ¸²æŸ“å™¨ä¸æ˜¾ç¤ºæ•°æ®

**åŸå› **:
- `parseXXX` å‡½æ•°æ²¡æœ‰ç§»é™¤è½¬ä¹‰ç¬¦
- è¿”å› null å¯¼è‡´å¡ç‰‡ä¸æ¸²æŸ“

**è§£å†³æ–¹æ¡ˆ**:
```tsx
export function parseCameraSetting(params: Record<string, any>): CameraSettingInfo | null {
  if (!params.setting) return null;
  
  try {
    const cleanedSetting = params.setting.replace(/\\/g, ''); // å…³é”®æ­¥éª¤
    return JSON.parse(cleanedSetting);
  } catch (e) {
    console.error('è§£æå¤±è´¥:', e);
    return null; // ç¡®ä¿é”™è¯¯æ—¶è¿”å› null
  }
}
```

---

## å¼€å‘æ–°å‘½ä»¤ç¼–è¾‘å™¨çš„æ£€æŸ¥æ¸…å•

### 1. ç¡®å®šç¼–è¾‘æ¨¡å¼
- [ ] ç¡®å®šå‘½ä»¤å±äºå“ªç§æ¨¡å¼ï¼ˆç®€å•å‚æ•° / Group é¡¹ / å¤æ‚ JSONï¼‰
- [ ] æŸ¥çœ‹ç±»ä¼¼å‘½ä»¤çš„å®ç°ä½œä¸ºå‚è€ƒ
- [ ] ç¡®å®šæ˜¯å¦éœ€è¦æ·»åŠ åŠŸèƒ½ï¼ˆä»… Group ç±»å‘½ä»¤ï¼‰

### 2. åˆ›å»ºç¼–è¾‘å™¨ç»„ä»¶
- [ ] å®šä¹‰æ•°æ®æ¥å£ï¼ˆå¦‚æœæ˜¯æ¨¡å¼ä¸‰ï¼‰
- [ ] å®ç° parseSetting / serializeSettingï¼ˆæ¨¡å¼ä¸‰ï¼‰
- [ ] è®¾ç½®çŠ¶æ€å’Œåˆå§‹åŒ–
- [ ] å®ç°åŒå‘åŒæ­¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] åˆ›å»ºè¡¨å•é…ç½® (FormSection[])

### 3. æ›´æ–°æ¸²æŸ“å™¨
- [ ] å®ç° parseXXX å‡½æ•°
- [ ] ç§»é™¤ JSON å‚æ•°çš„è½¬ä¹‰ç¬¦
- [ ] è¿”å›æ­£ç¡®çš„æ•°æ®ç»“æ„
- [ ] æ·»åŠ  AddItemButtonï¼ˆä»… Group ç±»å‘½ä»¤ï¼‰
- [ ] æ¥æ”¶å¹¶ä½¿ç”¨ onAddItem å›è°ƒ
- [ ] é”™è¯¯å¤„ç†è¿”å› null

### 4.å®ç° handleAddGroupItemï¼ˆä»… Group ç±»å‘½ä»¤ï¼‰
- [ ] åœ¨ renderCommandDetails ä¸­ä¼ é€’ onAddItem å›è°ƒ
- [ ] ä¿å­˜é€»è¾‘ä¸­å¤„ç† editingItemIndex === -2ï¼ˆæ·»åŠ æ¨¡å¼ï¼‰
- [ ]  æ›´æ–° App.tsx
- [ ] æ·»åŠ ç¼–è¾‘é€»è¾‘ï¼ˆæ¨¡å¼äºŒéœ€è¦ä¸“é—¨çš„ä¿å­˜å‡½æ•°ï¼‰
- [ ] æ›´æ–° updateCommandTextï¼ˆæ¨¡å¼ä¸‰éœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
- [ ] ç¡®ä¿ clip å‚æ•°è¢«ä¿ç•™
- [ ] æµ‹è¯•å¡ç‰‡åˆ—è¡¨å’Œé€‰ä¸­çŠ¶æ€æ›´æ–°

### 5. æµ‹è¯•ï¼ˆæ¨¡å¼ä¸‰ï¼‰
- [ ] æ·»åŠ æ–°é¡¹ â†’ æˆåŠŸæ·»åŠ å¹¶æ˜¾ç¤ºï¼ˆæ¨¡å¼äºŒï¼‰
- [ ] æ·»åŠ æŒ‰é’®æ˜¾ç¤ºæ­£ç¡®ï¼ˆæ¨¡å¼äºŒï¼‰
- [ ] å¯¹è¯æ¡†æ ‡é¢˜åŒºåˆ†"æ·»åŠ "å’Œ"ç¼–è¾‘"ï¼ˆæ¨¡å¼äºŒï¼‰
- [ ] ç¼–è¾‘å‚æ•° â†’ å¡ç‰‡æ­£æ–‡å®æ—¶æ›´æ–°
- [ ] ä¿å­˜å â†’ åŸå§‹å‘½ä»¤æ­£ç¡®æ›´æ–°
- [ ] ç›´æ¥ç¼–è¾‘åŸå§‹å‘½ä»¤ â†’ ç¼–è¾‘å™¨è¡¨å•å®æ—¶æ›´æ–°
- [ ] Clip å‚æ•°ä¸ä¸¢å¤±
- [ ] å¡ç‰‡ä¸æ¶ˆå¤±
- [ ] åˆ·æ–°åæ•°æ®æ­£ç¡®

---

## æ€»ç»“

### ä¸‰ç§æ¨¡å¼å¯¹æ¯”

| æ·»åŠ åŠŸèƒ½ | ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆAddItemButtonï¼‰ | ä¸æ”¯æŒ |
| ç¼–è¾‘æ¨¡å¼æ ‡è¯† | N/A | `editingItemIndex` (-2=æ·»åŠ , >=0=ç¼–è¾‘) | N/A |
| ç‰¹æ€§ | æ¨¡å¼ä¸€ | æ¨¡å¼äºŒ | æ¨¡å¼ä¸‰ |
|------|--------|--------|--------|
| çŠ¶æ€ç®¡ç† | ç›´æ¥ä¿®æ”¹ card | ç‹¬ç«‹ç¼–è¾‘çŠ¶æ€ | å†…éƒ¨æ•°æ®ç»“æ„ + card |
| å®æ—¶åŒæ­¥ | å•å‘ (ç¼–è¾‘å™¨ â†’ card) | ä¿å­˜æ—¶åŒæ­¥ | åŒå‘åŒæ­¥ |
| å‘½ä»¤æ›´æ–° | æ­£åˆ™æ›¿æ¢ | å®Œæ•´é‡å»º | å®Œæ•´é‡å»º |
| è½¬ä¹‰å¤„ç† | ä¸æ¶‰åŠ | éƒ¨åˆ†æ¶‰åŠ (transform) | æ ¸å¿ƒé€»è¾‘ |
| å¤æ‚åº¦ | ä½ | ä¸­ | é«˜ |
| ç¤ºä¾‹ | dialogue | backgroundgroup | camerasetting |

### å…³é”®åŸåˆ™

1. **è½¬ä¹‰æ ¼å¼ä¸€è‡´æ€§**: 
   - åŸå§‹å‘½ä»¤: `\{...\}`
   - params å­˜å‚¨: `\{...\}`
   - è§£æ/æ¸²æŸ“: ç§»é™¤è½¬ä¹‰ `{...}`
   - åºåˆ—åŒ–: æ·»åŠ è½¬ä¹‰ `\{...\}`

2. **é¿å…å¾ªç¯æ›´æ–°**:
   - ä½¿ç”¨ `isInitialized` æ ‡è®°
   - æ¯”è¾ƒå€¼æ˜¯å¦çœŸçš„æ”¹å˜
   - åˆç†è®¾ç½® useEffect ä¾èµ–

3. **æ·»åŠ åŠŸèƒ½è§„èŒƒ** (ä»…æ¨¡å¼äºŒ):
   - ä½¿ç”¨ `editingItemIndex = -2` æ ‡è¯†æ·»åŠ æ¨¡å¼
   - æä¾›åˆç†çš„é»˜è®¤å€¼
   - å¯¹è¯æ¡†æ ‡é¢˜åŠ¨æ€æ˜¾ç¤º
   - æ¸²æŸ“å™¨å¿…é¡»æ¥æ”¶å¹¶ä½¿ç”¨ `onAddItem` å›è°ƒ
   - ä¿å­˜é€»è¾‘ä¸­åŒºåˆ†æ·»åŠ å’Œç¼–è¾‘

5. **ä¿ç•™æ‰€æœ‰å‚æ•°**:
   - æ›´æ–°æ—¶å¿…é¡»ä¿ç•™ clip
   - Group å‘½ä»¤ä¿ç•™å…¶ä»–å­—æ®µ
   - é‡å»ºæ—¶åŒ…å«æ‰€æœ‰å¿…è¦å‚æ•°

4. **é”™è¯¯å¤„ç†**:
   - JSON è§£æå¤±è´¥è¿”å›é»˜è®¤å€¼æˆ– null
   - æ·»åŠ  console.log å¸®åŠ©è°ƒè¯•
   - ç¡®ä¿é”™è¯¯ä¸ä¼šå¯¼è‡´å¡ç‰‡æ¶ˆå¤±

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-04  
**ç»´æŠ¤è€…**: Editor2 å¼€å‘å›¢é˜Ÿ
