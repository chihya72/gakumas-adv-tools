# ADV å‘½ä»¤åºåˆ—åŒ–å®Œæ•´æŒ‡å—

> æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† ADV å‘½ä»¤ä»å¯¼å…¥åˆ°å¯¼å‡ºçš„å®Œæ•´æµç¨‹ï¼Œä»¥åŠå¦‚ä½•æ­£ç¡®å¤„ç† JSON å‚æ•°çš„åºåˆ—åŒ–ï¼Œé¿å…è½¬ä¹‰é”™è¯¯ã€‚

## ç›®å½•

1. [æ ¸å¿ƒæ¦‚å¿µï¼šADV è„šæœ¬æ ¼å¼](#æ ¸å¿ƒæ¦‚å¿µadv-è„šæœ¬æ ¼å¼)
2. [å®Œæ•´å·¥ä½œæµç¨‹](#å®Œæ•´å·¥ä½œæµç¨‹)
3. [JSON å‚æ•°è½¬ä¹‰è§„åˆ™](#json-å‚æ•°è½¬ä¹‰è§„åˆ™)
4. [å‘½ä»¤å®ç°è§„èŒƒ](#å‘½ä»¤å®ç°è§„èŒƒ)
5. [å¸¸è§é—®é¢˜æ¡ˆä¾‹](#å¸¸è§é—®é¢˜æ¡ˆä¾‹)
6. [æµ‹è¯•éªŒè¯æ–¹æ³•](#æµ‹è¯•éªŒè¯æ–¹æ³•)

---

## æ ¸å¿ƒæ¦‚å¿µï¼šADV è„šæœ¬æ ¼å¼

### åŸºæœ¬å‘½ä»¤æ ¼å¼

```
[å‘½ä»¤å å‚æ•°1=å€¼1 å‚æ•°2=å€¼2 clip=\{...\}]
```

### JSON å‚æ•°æ ¼å¼

ADV è„šæœ¬ä¸­çš„ JSON å‚æ•°æœ‰ç‰¹æ®Šçš„è½¬ä¹‰è¦æ±‚ï¼š

```
[camerasetting setting=\{"focalLength":30.0,"transform":\{"position":\{"x":0.0,"y":1.0,"z":2.0\}\}\}]
```

**å…³é”®è§„åˆ™**ï¼š
- âœ… **æ‰€æœ‰å¤§æ‹¬å·å¿…é¡»è½¬ä¹‰**ï¼š`{` â†’ `\{`ï¼Œ`}` â†’ `\}`
- âœ… **å¼•å·ä¸è½¬ä¹‰**ï¼šä¿æŒ `"` åŸæ ·
- âœ… **åŒ…æ‹¬åµŒå¥— JSON å†…éƒ¨çš„å¤§æ‹¬å·**

### Group å‘½ä»¤æ ¼å¼

ç‰¹æ®Šçš„ group å‘½ä»¤ä½¿ç”¨åµŒå¥—æ–¹æ‹¬å·ï¼š

```
[backgroundgroup backgrounds=[background id=entrance src=env_2d_adv_school-entrance-00-noon] backgrounds=[background id=P_heya src=env_3d_adv_classroom-00-00-noon]]
```

```
[actorlayoutgroup layouts=[actorlayout id=amao transform=\{"position":\{"x":0.0,"y":0.0,"z":0.0\}\}] clip=\{...\}]
```

---

## å®Œæ•´å·¥ä½œæµç¨‹

### 1. å¯¼å…¥é˜¶æ®µï¼ˆParser â†’ Editorï¼‰

**æ–‡ä»¶**: `parser/parser.py`

**åŠŸèƒ½**: å°† ADV è„šæœ¬è§£æä¸ºç»“æ„åŒ–æ•°æ®

**å…³é”®ç‚¹**ï¼š
- è§£æå‘½ä»¤åå’Œå‚æ•°
- **ä¿ç•™åŸå§‹ raw_line**ï¼ˆåŒ…å«æ‰€æœ‰è½¬ä¹‰å­—ç¬¦ï¼‰
- è§£æ JSON å‚æ•°æ—¶**ä¸è¦ç§»é™¤è½¬ä¹‰å­—ç¬¦**
- ç‰¹æ®Šå¤„ç† group å‘½ä»¤çš„åµŒå¥—ç»“æ„

**ç¤ºä¾‹**ï¼š
```python
# æ­£ç¡®ï¼šä¿ç•™åŸå§‹æ ¼å¼
{
    "command": "camerasetting",
    "params": {
        "setting": r'\{"focalLength":30.0\}'  # ä¿ç•™åæ–œæ 
    },
    "raw_line": '[camerasetting setting=\\{"focalLength":30.0\\}]'
}
```

### 2. åˆ†æé˜¶æ®µï¼ˆEditor Internalï¼‰

**æ–‡ä»¶**: `src/types/command.ts`

**æ•°æ®ç»“æ„è®¾è®¡åŸåˆ™**ï¼š

#### æ–¹æ¡ˆ Aï¼šå¯¹è±¡å­˜å‚¨ï¼ˆæ¨èï¼‰

é€‚ç”¨äºï¼š`setting`ã€`transform` ç­‰ JSON å‚æ•°

```typescript
interface Command {
  command: string;
  params: {
    setting?: object;  // å­˜å‚¨ä¸ºå¯¹è±¡ï¼Œåºåˆ—åŒ–æ—¶ç»Ÿä¸€å¤„ç†
  };
  clip?: ClipData;
  raw_line: string;
}
```

**ä¼˜ç‚¹**ï¼š
- æ•°æ®ç±»å‹æ˜ç¡®
- åºåˆ—åŒ–é€»è¾‘ç»Ÿä¸€
- ä¸æ˜“å‡ºé”™

#### æ–¹æ¡ˆ Bï¼šå­—ç¬¦ä¸²å­˜å‚¨ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰

é€‚ç”¨äºï¼šç‰¹æ®Šçš„åµŒå¥—ç»“æ„ï¼ˆå¦‚ `layouts` å‚æ•°ï¼‰

```typescript
interface Command {
  command: string;
  params: {
    layouts?: string;  // "actorlayout id=amao transform=\\{...\\}|||actorlayout id=chisa..."
  };
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ **å¿…é¡»åœ¨ä¿å­˜æ—¶å°±å®Œæˆè½¬ä¹‰**
- âš ï¸ **ç¡®ä¿å¤šå¤„ä½¿ç”¨æ—¶æ ¼å¼ä¸€è‡´**
- âš ï¸ **ä¼˜å…ˆè€ƒè™‘æ–¹æ¡ˆ A**

### 3. æ˜¾ç¤ºé˜¶æ®µï¼ˆUI ç»„ä»¶ï¼‰

**æ–‡ä»¶**: `src/components/CommandPanel/`

**å…³é”®ç‚¹**ï¼š
- æ˜¾ç¤ºæ—¶å°†å¯¹è±¡è½¬ä¸ºäººç±»å¯è¯»æ ¼å¼
- ä¸éœ€è¦æ˜¾ç¤ºè½¬ä¹‰å­—ç¬¦
- ä½¿ç”¨ `JSON.stringify(obj, null, 2)` ç¾åŒ–æ˜¾ç¤º

**ç¤ºä¾‹**ï¼š
```tsx
// æ˜¾ç¤º transform å‚æ•°
<div>
  <label>Transform:</label>
  <pre>{JSON.stringify(params.transform, null, 2)}</pre>
</div>
```

### 4. ç¼–è¾‘é˜¶æ®µï¼ˆSave å‡½æ•°ï¼‰

**æ–‡ä»¶**: `src/components/App/App.tsx`

**è¿™æ˜¯æœ€å…³é”®çš„é˜¶æ®µï¼Œå¿…é¡»ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®ï¼**

#### å¯¹è±¡ç±»å‹å‚æ•°ï¼ˆæ¨èæ¨¡å¼ï¼‰

```typescript
// âœ… æ­£ç¡®ï¼šå­˜å‚¨ä¸ºå¯¹è±¡ï¼Œåºåˆ—åŒ–æ—¶ç»Ÿä¸€å¤„ç†
function saveCameraSettingItem(id: string, updates: any) {
  const updatedCommand = {
    ...existingCommand,
    params: {
      ...existingCommand.params,
      setting: updates.setting  // ç›´æ¥å­˜å‚¨å¯¹è±¡
    }
  };
}
```

#### å­—ç¬¦ä¸²ç±»å‹å‚æ•°ï¼ˆéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼‰

```typescript
// âœ… æ­£ç¡®ï¼šä¿å­˜æ—¶å°±å®Œæˆè½¬ä¹‰
function saveActorLayoutGroupItem(id: string, updates: any) {
  const layouts = updates.layouts || [];
  
  // ç”Ÿæˆ params.layouts å­—ç¬¦ä¸²
  const newLayoutsParam = layouts
    .map((layout: any) => {
      const parts = [];
      if (layout.id) parts.push(`id=${layout.id}`);
      if (layout.transform) {
        // ğŸ”´ å…³é”®ï¼šæ‰€æœ‰å¤§æ‹¬å·éƒ½è¦è½¬ä¹‰
        const transformStr = JSON.stringify(layout.transform)
          .replace(/\{/g, '\\{')
          .replace(/\}/g, '\\}');
        parts.push(`transform=${transformStr}`);
      }
      return 'actorlayout ' + parts.join(' ');
    })
    .join('|||');
  
  // ç”Ÿæˆ raw_line
  const layoutStrs = layouts.map((layout: any) => {
    const parts = [];
    if (layout.id) parts.push(`id=${layout.id}`);
    if (layout.transform) {
      // ğŸ”´ å…³é”®ï¼šåŒæ ·éœ€è¦è½¬ä¹‰æ‰€æœ‰å¤§æ‹¬å·
      const transformStr = JSON.stringify(layout.transform)
        .replace(/\{/g, '\\{')
        .replace(/\}/g, '\\}');
      parts.push(`transform=${transformStr}`);
    }
    return `[actorlayout ${parts.join(' ')}]`;
  });
  
  const updatedCommand = {
    ...existingCommand,
    params: {
      ...existingCommand.params,
      layouts: newLayoutsParam  // å·²è½¬ä¹‰çš„å­—ç¬¦ä¸²
    },
    raw_line: `[actorlayoutgroup layouts=${layoutStrs.join(' layouts=')}]`
  };
}
```

**å¸¸è§é”™è¯¯**ï¼š

```typescript
// âŒ é”™è¯¯ 1ï¼šåªè½¬ä¹‰å¤–å±‚å¤§æ‹¬å·
.replace(/^\{/, '\\{').replace(/\}$/, '\\}')

// âŒ é”™è¯¯ 2ï¼šä¿å­˜æ—¶ä¸è½¬ä¹‰
const transformStr = JSON.stringify(layout.transform);  // ç¼ºå°‘ replace

// âŒ é”™è¯¯ 3ï¼šå¤šå¤„è½¬ä¹‰ä¸ä¸€è‡´
// raw_line è½¬ä¹‰äº†ï¼Œä½† params.layouts æ²¡è½¬ä¹‰
```

### 5. å¯¼å‡ºé˜¶æ®µï¼ˆSerializerï¼‰

**æ–‡ä»¶**: `src/components/App/serializer.ts`

**æ ¸å¿ƒå‡½æ•°**ï¼š

#### serializeClipToJson()

```typescript
function serializeClipToJson(clip: ClipData): string {
  const clipObj = {
    clipType: clip.clipType,
    transitionType: clip.transitionType,
    // ... å…¶ä»–å­—æ®µ
  };
  
  let jsonStr = JSON.stringify(clipObj);
  
  // ğŸ”´ è½¬ä¹‰æ‰€æœ‰å¤§æ‹¬å·
  const escapedJson = jsonStr.replace(/\{/g, '\\{').replace(/\}/g, '\\}');
  
  return escapedJson;
}
```

#### serializeJsonParam()

```typescript
function serializeJsonParam(obj: any): string {
  let jsonStr = JSON.stringify(obj);
  
  // ğŸ”´ è½¬ä¹‰æ‰€æœ‰å¤§æ‹¬å·
  return jsonStr.replace(/\{/g, '\\{').replace(/\}/g, '\\}');
}
```

#### serializeCommand()

```typescript
function serializeCommand(cmd: Command): string {
  const paramParts: string[] = [];
  
  for (const [key, value] of Object.entries(cmd.params)) {
    if (key === 'clip') continue;  // clip å•ç‹¬å¤„ç†
    
    if (typeof value === 'object') {
      // ğŸ”´ å¯¹è±¡ç±»å‹ï¼šä½¿ç”¨ç»Ÿä¸€çš„åºåˆ—åŒ–å‡½æ•°
      const jsonStr = serializeJsonParam(value);
      paramParts.push(`${key}=${jsonStr}`);
    } else if (typeof value === 'string') {
      // ğŸ”´ å­—ç¬¦ä¸²ç±»å‹ï¼š
      // - å¦‚æœæ˜¯ layouts ç­‰ç‰¹æ®Šå‚æ•°ï¼Œåº”è¯¥å·²ç»åœ¨ä¿å­˜æ—¶è½¬ä¹‰è¿‡
      // - ç›´æ¥ä½¿ç”¨å³å¯
      if (key === 'layouts') {
        // ç‰¹æ®Šå¤„ç†ï¼šæ‹†åˆ†å¹¶é‡ç»„ä¸ºåµŒå¥—æ ¼å¼
        const items = value.split('|||');
        const formattedItems = items.map(item => `[${item}]`).join(' layouts=');
        paramParts.push(`layouts=${formattedItems}`);
      } else {
        paramParts.push(`${key}=${value}`);
      }
    }
  }
  
  // æ·»åŠ  clipï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  if (cmd.clip) {
    const clipStr = serializeClipToJson(cmd.clip);
    paramParts.push(`clip=${clipStr}`);
  }
  
  return `[${cmd.command} ${paramParts.join(' ')}]`;
}
```

---

## JSON å‚æ•°è½¬ä¹‰è§„åˆ™

### è§„åˆ™æ€»ç»“

| å­—ç¬¦ | æ˜¯å¦è½¬ä¹‰ | è½¬æ¢è§„åˆ™ |
|------|---------|---------|
| `{`  | âœ… æ˜¯   | `{` â†’ `\{` |
| `}`  | âœ… æ˜¯   | `}` â†’ `\}` |
| `"`  | âŒ å¦   | ä¿æŒä¸å˜ |
| `:`  | âŒ å¦   | ä¿æŒä¸å˜ |
| `,`  | âŒ å¦   | ä¿æŒä¸å˜ |
| `\n` | âŒ å¦   | ä¸åº”å‡ºç°ï¼ˆä½¿ç”¨ç´§å‡‘ JSONï¼‰ |

### è½¬ä¹‰å‡½æ•°

```typescript
// æ ‡å‡†è½¬ä¹‰å‡½æ•°
function escapeJsonForADV(obj: any): string {
  const jsonStr = JSON.stringify(obj);  // ç´§å‡‘æ ¼å¼ï¼Œæ— ç©ºæ ¼
  return jsonStr.replace(/\{/g, '\\{').replace(/\}/g, '\\}');
}
```

### æ­£ç¡®ç¤ºä¾‹

```typescript
// è¾“å…¥å¯¹è±¡
const setting = {
  focalLength: 30.0,
  transform: {
    position: { x: 0.0, y: 1.0, z: 2.0 }
  }
};

// âœ… æ­£ç¡®è¾“å‡º
const output = escapeJsonForADV(setting);
// \{"focalLength":30.0,"transform":\{"position":\{"x":0.0,"y":1.0,"z":2.0\}\}\}
```

### é”™è¯¯ç¤ºä¾‹

```typescript
// âŒ é”™è¯¯ 1ï¼šåªè½¬ä¹‰å¤–å±‚
.replace(/^\{/, '\\{').replace(/\}$/, '\\}')
// ç»“æœï¼š\{"focalLength":30.0,"transform":{"position":{"x":0.0,"y":1.0,"z":2.0}}\}
// é—®é¢˜ï¼šå†…å±‚å¤§æ‹¬å·æœªè½¬ä¹‰

// âŒ é”™è¯¯ 2ï¼šè½¬ä¹‰äº†å¼•å·
.replace(/\{/g, '\\{').replace(/\}/g, '\\}').replace(/"/g, '\\"')
// ç»“æœï¼š\{\"focalLength\":30.0\}
// é—®é¢˜ï¼šå¼•å·ä¸åº”è¯¥è½¬ä¹‰

// âŒ é”™è¯¯ 3ï¼šä½¿ç”¨ç¾åŒ– JSON
JSON.stringify(obj, null, 2)
// ç»“æœï¼šåŒ…å«æ¢è¡Œç¬¦å’Œç¼©è¿›
// é—®é¢˜ï¼šADV æ ¼å¼è¦æ±‚ç´§å‡‘çš„å•è¡Œ JSON
```

---

## å‘½ä»¤å®ç°è§„èŒƒ

### æ–°å¢å‘½ä»¤æ—¶çš„æ£€æŸ¥æ¸…å•

#### 1. ç¡®å®šå‚æ•°ç±»å‹

- [ ] åˆ—å‡ºæ‰€æœ‰å‚æ•°
- [ ] ç¡®å®šå“ªäº›å‚æ•°æ˜¯ JSON æ ¼å¼
- [ ] ç¡®å®šå‚æ•°çš„å­˜å‚¨æ–¹å¼ï¼ˆå¯¹è±¡ or å­—ç¬¦ä¸²ï¼‰

#### 2. è®¾è®¡æ•°æ®ç»“æ„

```typescript
// åœ¨ src/types/command.ts ä¸­å®šä¹‰
interface YourCommandParams {
  // âœ… æ¨èï¼šå¯¹è±¡ç±»å‹
  setting?: {
    focalLength: number;
    transform: Transform;
  };
  
  // âš ï¸ è°¨æ…ä½¿ç”¨ï¼šå­—ç¬¦ä¸²ç±»å‹
  layouts?: string;  // å¦‚æœä½¿ç”¨ï¼Œå¿…é¡»åœ¨ä¿å­˜æ—¶è½¬ä¹‰
}
```

#### 3. å®ç°è§£æé€»è¾‘ï¼ˆParserï¼‰

```python
# parser.py
def parse_your_command(line):
    # ä¿ç•™åŸå§‹ raw_line
    raw_line = line
    
    # è§£æå‚æ•°
    # æ³¨æ„ï¼šJSON å‚æ•°ä¿ç•™è½¬ä¹‰å­—ç¬¦
    params = {}
    
    return {
        "command": "yourcommand",
        "params": params,
        "raw_line": raw_line
    }
```

#### 4. å®ç°ç¼–è¾‘é€»è¾‘ï¼ˆApp.tsxï¼‰

```typescript
function saveYourCommandItem(id: string, updates: any) {
  // æ–¹å¼ Aï¼šå¯¹è±¡å­˜å‚¨ï¼ˆæ¨èï¼‰
  const updatedCommand = {
    ...existingCommand,
    params: {
      ...existingCommand.params,
      setting: updates.setting  // å¯¹è±¡å½¢å¼
    }
  };
  
  // æ–¹å¼ Bï¼šå­—ç¬¦ä¸²å­˜å‚¨ï¼ˆéœ€è¦è½¬ä¹‰ï¼‰
  // å¦‚æœä½¿ç”¨å­—ç¬¦ä¸²ï¼Œå¿…é¡»åœ¨è¿™é‡Œè½¬ä¹‰ï¼
  const settingStr = JSON.stringify(updates.setting)
    .replace(/\{/g, '\\{')
    .replace(/\}/g, '\\}');
  
  const updatedCommand = {
    ...existingCommand,
    params: {
      ...existingCommand.params,
      setting: settingStr  // å·²è½¬ä¹‰çš„å­—ç¬¦ä¸²
    }
  };
}
```

#### 5. å®ç°åºåˆ—åŒ–é€»è¾‘ï¼ˆserializer.tsï¼‰

```typescript
// åœ¨ serializeCommand() ä¸­æ·»åŠ å¤„ç†
if (typeof value === 'object') {
  // å¯¹è±¡ç±»å‹ï¼šç»Ÿä¸€å¤„ç†
  const jsonStr = serializeJsonParam(value);
  paramParts.push(`${key}=${jsonStr}`);
} else if (typeof value === 'string') {
  // å­—ç¬¦ä¸²ç±»å‹ï¼šåº”è¯¥å·²ç»è½¬ä¹‰è¿‡
  paramParts.push(`${key}=${value}`);
}
```

#### 6. æµ‹è¯•éªŒè¯

- [ ] å¯¼å…¥åŸå§‹æ–‡ä»¶
- [ ] ç¼–è¾‘å‘½ä»¤å‚æ•°
- [ ] å¯¼å‡ºæ–‡ä»¶
- [ ] å¯¹æ¯”åŸå§‹æ–‡ä»¶å’Œå¯¼å‡ºæ–‡ä»¶
- [ ] éªŒè¯è½¬ä¹‰æ ¼å¼æ­£ç¡®

---

## å¸¸è§é—®é¢˜æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šactorlayoutgroup åºåˆ—åŒ–é—®é¢˜

**é—®é¢˜æè¿°**ï¼šç¼–è¾‘åå¯¼å‡ºï¼Œ`transform` å‚æ•°è½¬ä¹‰ä¸å®Œæ•´

**åŸå› åˆ†æ**ï¼š

åœ¨ `App.tsx` ä¸­æœ‰ä¸¤å¤„ä¿å­˜ `transform`ï¼Œä½¿ç”¨äº†ä¸åŒçš„è½¬ä¹‰ç­–ç•¥ï¼š

1. **raw_line**: åªè½¬ä¹‰å¤–å±‚å¤§æ‹¬å· `replace(/^\{/, '\\{').replace(/\}$/, '\\}')`
2. **params.layouts**: å®Œå…¨ä¸è½¬ä¹‰ `JSON.stringify(layout.transform)`

**è§£å†³æ–¹æ¡ˆ**ï¼šç»Ÿä¸€ä½¿ç”¨å…¨å±€è½¬ä¹‰

```typescript
// æ­£ç¡®æ–¹å¼
const transformStr = JSON.stringify(layout.transform)
  .replace(/\{/g, '\\{')
  .replace(/\}/g, '\\}');
```

### æ¡ˆä¾‹ 2ï¼šå¯¹è±¡ç±»å‹ vs å­—ç¬¦ä¸²ç±»å‹

**åœºæ™¯**ï¼š`camerasetting` çš„ `setting` å‚æ•°

**âœ… æ­£ç¡®å®ç°**ï¼š

```typescript
// å­˜å‚¨ä¸ºå¯¹è±¡
params: {
  setting: {
    focalLength: 30.0,
    transform: { position: { x: 0, y: 1, z: 2 } }
  }
}

// åºåˆ—åŒ–æ—¶ç»Ÿä¸€å¤„ç†
const jsonStr = serializeJsonParam(params.setting);
```

**âŒ é”™è¯¯å®ç°**ï¼š

```typescript
// å­˜å‚¨ä¸ºå­—ç¬¦ä¸²ï¼Œä½†è½¬ä¹‰ä¸å®Œæ•´
params: {
  setting: '{"focalLength":30.0,"transform":{"position":{"x":0}}}'  // æœªè½¬ä¹‰
}
```

### æ¡ˆä¾‹ 3ï¼šClip å‚æ•°å¤„ç†

**âœ… Clip å‚æ•°å·²æœ‰ç»Ÿä¸€å¤„ç†ï¼Œä¸ä¼šå‡ºé”™**

æ‰€æœ‰å‘½ä»¤çš„ `clip` å‚æ•°éƒ½é€šè¿‡ `serializeClipToJson()` å‡½æ•°å¤„ç†ï¼š

```typescript
function serializeClipToJson(clip: ClipData): string {
  // ... æ„å»ºå¯¹è±¡
  let jsonStr = JSON.stringify(clipObj);
  return jsonStr.replace(/\{/g, '\\{').replace(/\}/g, '\\}');
}
```

---

## æµ‹è¯•éªŒè¯æ–¹æ³•

### è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

#### 1. å¯¹æ¯”å¯¼å‡ºæ–‡ä»¶ï¼ˆtest_export.pyï¼‰

```bash
python test_export.py original.txt exported.txt
```

**åŠŸèƒ½**ï¼šé€è¡Œå¯¹æ¯”ä¸¤ä¸ªæ–‡ä»¶ï¼Œæ˜¾ç¤ºå·®å¼‚

#### 2. éªŒè¯è½¬ä¹‰æ ¼å¼ï¼ˆtest_transform_serialization.pyï¼‰

```bash
python test_transform_serialization.py exported.txt
```

**åŠŸèƒ½**ï¼šæ£€æŸ¥æ‰€æœ‰ JSON å‚æ•°çš„å¤§æ‹¬å·æ˜¯å¦æ­£ç¡®è½¬ä¹‰

### æ‰‹åŠ¨æµ‹è¯•æµç¨‹

1. **å‡†å¤‡æµ‹è¯•æ–‡ä»¶**
   - é€‰æ‹©åŒ…å«ç›®æ ‡å‘½ä»¤çš„ ADV æ–‡ä»¶
   - ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®

2. **å¯¼å…¥æµ‹è¯•**
   ```
   åŠ è½½ç¤ºä¾‹ â†’ æ£€æŸ¥å‘½ä»¤æ˜¯å¦æ­£ç¡®è§£æ
   ```

3. **ç¼–è¾‘æµ‹è¯•**
   ```
   ç¼–è¾‘å‘½ä»¤å‚æ•° â†’ ä¿å­˜ â†’ æ£€æŸ¥å†…éƒ¨æ•°æ®ç»“æ„
   ```

4. **å¯¼å‡ºæµ‹è¯•**
   ```
   å¯¼å‡ºæ–‡ä»¶ â†’ å¯¹æ¯”åŸæ–‡ä»¶ â†’ éªŒè¯æ ¼å¼
   ```

5. **éªŒè¯è¦ç‚¹**
   - [ ] æ‰€æœ‰å¤§æ‹¬å·éƒ½è½¬ä¹‰ä¸º `\{` å’Œ `\}`
   - [ ] å¼•å·æœªè½¬ä¹‰ï¼Œä¿æŒ `"`
   - [ ] å‘½ä»¤é¡ºåºæ­£ç¡®ï¼ˆæŒ‰ sortKeyï¼‰
   - [ ] åµŒå¥—ç»“æ„æ­£ç¡®ï¼ˆgroup å‘½ä»¤ï¼‰
   - [ ] å‚æ•°å®Œæ•´ï¼Œæ— ä¸¢å¤±

### ä½¿ç”¨ PowerShell å¿«é€ŸéªŒè¯

```powershell
# å¯¹æ¯”æ–‡ä»¶è¡Œæ•°
$orig = Get-Content "original.txt" -Encoding UTF8
$export = Get-Content "exported.txt" -Encoding UTF8
Write-Host "åŸå§‹: $($orig.Count) è¡Œ, å¯¼å‡º: $($export.Count) è¡Œ"

# æ£€æŸ¥ç‰¹å®šè¡Œ
for ($i = 0; $i -lt 10; $i++) {
  if ($orig[$i] -ne $export[$i]) {
    Write-Host "è¡Œ $($i+1) æœ‰å·®å¼‚"
    Write-Host "åŸå§‹: $($orig[$i].Substring(0, 100))"
    Write-Host "å¯¼å‡º: $($export[$i].Substring(0, 100))"
  }
}
```

---

## å‘½ä»¤ç±»å‹å¯¹ç…§è¡¨

| å‘½ä»¤ç±»å‹ | JSON å‚æ•° | å­˜å‚¨æ–¹å¼ | æ˜¯å¦æœ‰é—®é¢˜ | å¤‡æ³¨ |
|---------|----------|---------|-----------|------|
| camerasetting | setting | å¯¹è±¡ | âœ… æ­£å¸¸ | åºåˆ—åŒ–å™¨ç»Ÿä¸€å¤„ç† |
| backgroundsetting | setting | å¯¹è±¡ | âœ… æ­£å¸¸ | åºåˆ—åŒ–å™¨ç»Ÿä¸€å¤„ç† |
| actorfacialoverridemotion | setting | å¯¹è±¡ | âœ… æ­£å¸¸ | åºåˆ—åŒ–å™¨ç»Ÿä¸€å¤„ç† |
| actorlayoutgroup | layouts (å« transform) | å­—ç¬¦ä¸² | âš ï¸ å·²ä¿®å¤ | éœ€ç¡®ä¿ä¿å­˜æ—¶è½¬ä¹‰ |
| backgroundlayoutgroup | layouts (å« transform) | å­—ç¬¦ä¸² | âš ï¸ å·²ä¿®å¤ | åŒ actorlayoutgroup |
| backgroundgroup | backgrounds | å­—ç¬¦ä¸² | âœ… æ­£å¸¸ | æ—  JSON å‚æ•° |
| actorgroup | actors | å­—ç¬¦ä¸² | âœ… æ­£å¸¸ | æ—  JSON å‚æ•° |
| æ‰€æœ‰å‘½ä»¤ | clip | å¯¹è±¡ | âœ… æ­£å¸¸ | ç»Ÿä¸€åºåˆ—åŒ–å‡½æ•° |

---

## æœ€ä½³å®è·µæ€»ç»“

### âœ… æ¨èåšæ³•

1. **ä¼˜å…ˆä½¿ç”¨å¯¹è±¡å­˜å‚¨** JSON å‚æ•°
2. **ä¿å­˜æ—¶ç«‹å³è½¬ä¹‰**ï¼Œä¸è¦æ‹–åˆ°åºåˆ—åŒ–æ—¶
3. **ä½¿ç”¨ç»Ÿä¸€çš„è½¬ä¹‰å‡½æ•°** `escapeJsonForADV()`
4. **ç¼–è¾‘åç«‹å³æµ‹è¯•å¯¼å‡º**ï¼ŒåŠæ—©å‘ç°é—®é¢˜
5. **ä¿ç•™åŸå§‹ raw_line**ï¼Œä½†ä¸ä¾èµ–å®ƒå¯¼å‡º

### âŒ é¿å…åšæ³•

1. âŒ å¤šå¤„è½¬ä¹‰ï¼Œå®¹æ˜“ä¸ä¸€è‡´
2. âŒ åªè½¬ä¹‰å¤–å±‚å¤§æ‹¬å·
3. âŒ è½¬ä¹‰å¼•å·
4. âŒ ä½¿ç”¨ç¾åŒ– JSONï¼ˆåŒ…å«æ¢è¡Œï¼‰
5. âŒ å­—ç¬¦ä¸²å­˜å‚¨ä½†ä¸è½¬ä¹‰

### ğŸ” é—®é¢˜æ’æŸ¥æ­¥éª¤

é‡åˆ°å¯¼å‡ºé—®é¢˜æ—¶ï¼š

1. æ£€æŸ¥ **Save å‡½æ•°** ä¸­çš„è½¬ä¹‰é€»è¾‘
2. æ£€æŸ¥ **æ•°æ®ç»“æ„** æ˜¯å¯¹è±¡è¿˜æ˜¯å­—ç¬¦ä¸²
3. æ£€æŸ¥ **åºåˆ—åŒ–å™¨** çš„å¤„ç†é€»è¾‘
4. ä½¿ç”¨æµ‹è¯•è„šæœ¬éªŒè¯è½¬ä¹‰æ ¼å¼
5. å¯¹æ¯”å¯¼å‡ºæ–‡ä»¶å’ŒåŸå§‹æ–‡ä»¶

---

## ç›¸å…³æ–‡æ¡£

- [TRANSFORM_FIX.md](TRANSFORM_FIX.md) - actorlayoutgroup é—®é¢˜ä¿®å¤è®°å½•
- [EXPORT_IMPLEMENTATION.md](EXPORT_IMPLEMENTATION.md) - å¯¼å‡ºåŠŸèƒ½å®ç°è¯´æ˜
- [å‘½ä»¤ç¼–è¾‘å™¨å¼€å‘è§„èŒƒ.md](å‘½ä»¤ç¼–è¾‘å™¨å¼€å‘è§„èŒƒ.md) - ç¼–è¾‘å™¨å¼€å‘è§„èŒƒ
